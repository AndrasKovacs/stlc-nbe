
module PresheafModel where

open import Lib
open import UIP
open import Syntax
open import Embedding
open import Substitution
open import Nf

-- Tyá´º A : PSh ğ’ªPE
--------------------------------------------------------------------------------

mutual
  -- Action on objects
  Tyá´º : Ty â†’ Con â†’ Set
  Tyá´º Î¹       Î“ = Nf Î“ Î¹
  Tyá´º (A â‡’ B) Î“ =  
    Î£ (âˆ€ {Î”} â†’ OPE Î” Î“ â†’ Tyá´º A Î” â†’ Tyá´º B Î”) Î» fá´º â†’
    âˆ€ {Î” Î£}(Ïƒ : OPE Î” Î“)(Î´ : OPE Î£ Î”)(aá´º : Tyá´º A Î”) â†’ Tyá´ºâ‚‘ Î´ (fá´º Ïƒ aá´º) â‰¡ fá´º (Ïƒ âˆ˜â‚‘ Î´) (Tyá´ºâ‚‘ Î´ aá´º)

  -- Action on morphisms
  Tyá´ºâ‚‘ : âˆ€ {A Î“ Î”} â†’ OPE Î” Î“ â†’ Tyá´º A Î“ â†’ Tyá´º A Î”
  Tyá´ºâ‚‘ {Î¹}     Ïƒ tá´º            = tá´º [ Ïƒ ]Nfâ‚‘
  Tyá´ºâ‚‘ {A â‡’ B} Ïƒ (tá´º , tá´º-nat) =
    (Î» Î´ â†’ tá´º (Ïƒ âˆ˜â‚‘ Î´)) ,
    (Î» Î´ Î½ aá´º â†’ tá´º-nat (Ïƒ âˆ˜â‚‘ Î´) Î½ aá´º â—¾ (Î» x â†’ tá´º x (Tyá´ºâ‚‘ Î½ aá´º)) & assâ‚‘ Ïƒ Î´ Î½)

-- Equality constructor for semantic functions
â‡’á´º= :
  âˆ€ {Î“ A B}{f f' : Tyá´º (A â‡’ B) Î“}
  â†’ (âˆ€ {Î”}(Ïƒ : OPE Î” Î“) a â†’ projâ‚ f Ïƒ a â‰¡ projâ‚ f' Ïƒ a)
  â†’ f â‰¡ f'
â‡’á´º= {f = f}{f'} eq = ,Î£=
  (funexti Î» Î” â†’ funext Î» Ïƒ â†’ funext Î» aá´º â†’ eq Ïƒ aá´º )
  (funexti Î» _ â†’ funexti Î» _ â†’ funext Î» _ â†’ funext Î» _ â†’ funext Î» _ â†’ UIP _ _)

-- Action on identity morphism
idâ‚‘Tyá´º : âˆ€ {Î“ A}(tá´º : Tyá´º A Î“) â†’ Tyá´ºâ‚‘ idâ‚‘ tá´º â‰¡ tá´º
idâ‚‘Tyá´º {A = Î¹}     tá´º       = idâ‚‘Nf tá´º
idâ‚‘Tyá´º {A = A â‡’ B} (tá´º , _) = â‡’á´º= Î» Ïƒ aá´º â†’ (Î» x â†’ tá´º x aá´º) & idlâ‚‘ Ïƒ

-- Action on composition
âˆ˜â‚‘Tyá´º :
  âˆ€ {Î“ Î” Î£ A}(tá´º : Tyá´º A Î£)(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)
  â†’ Tyá´ºâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) tá´º â‰¡ Tyá´ºâ‚‘ Î´ (Tyá´ºâ‚‘ Ïƒ tá´º)
âˆ˜â‚‘Tyá´º {A = Î¹}     tá´º Ïƒ Î´ = âˆ˜â‚‘Nf tá´º Ïƒ Î´ â»Â¹
âˆ˜â‚‘Tyá´º {A = A â‡’ B} tá´º Ïƒ Î´ = â‡’á´º= (Î» Î½ aá´º â†’ (Î» x â†’ projâ‚ tá´º x aá´º) & assâ‚‘ Ïƒ Î´ Î½)


-- Coná´º Î“ : PSh ğ’ªPE
--------------------------------------------------------------------------------

-- Action on objects
data Coná´º : Con â†’ Con â†’ Set where
  âˆ™   : âˆ€ {Î“} â†’ Coná´º âˆ™ Î“
  _,_ : âˆ€ {A Î“ Î”} (Ïƒ : Coná´º Î“ Î”)(t : Tyá´º A Î”) â†’ Coná´º (Î“ , A) Î”
infixr 5 _,_

-- Action on morphisms
Coná´ºâ‚‘ : âˆ€ {Î“ Î”} â†’ OPE Î” Î“ â†’ âˆ€ {Î£} â†’ Coná´º Î£ Î“ â†’ Coná´º Î£ Î”
Coná´ºâ‚‘ Ïƒ âˆ™        = âˆ™
Coná´ºâ‚‘ Ïƒ (Î´ , tá´º) = Coná´ºâ‚‘ Ïƒ Î´ , Tyá´ºâ‚‘ Ïƒ tá´º

-- Action on composition
âˆ˜â‚‘OPEá´º :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(Î½ : Coná´º Î Î£)
  â†’ Coná´ºâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) Î½ â‰¡ Coná´ºâ‚‘ Î´ (Coná´ºâ‚‘ Ïƒ Î½)  
âˆ˜â‚‘OPEá´º Ïƒ Î´ âˆ™       = refl
âˆ˜â‚‘OPEá´º Ïƒ Î´ (Î½ , t) = _,_ & âˆ˜â‚‘OPEá´º Ïƒ Î´ Î½ âŠ— âˆ˜â‚‘Tyá´º t Ïƒ Î´

-- Action on identity
idâ‚‘Coná´º : âˆ€ {Î“ Î”}(Ïƒá´º : Coná´º Î“ Î”) â†’ Coná´ºâ‚‘ idâ‚‘ Ïƒá´º â‰¡ Ïƒá´º
idâ‚‘Coná´º âˆ™        = refl
idâ‚‘Coná´º (Ïƒá´º , t) = _,_ & idâ‚‘Coná´º Ïƒá´º âŠ— idâ‚‘Tyá´º t


-- âˆˆá´º v : Nat (Coná´º Î“) (Tyá´º A)
--------------------------------------------------------------------------------

âˆˆá´º : âˆ€ {Î“ A} â†’ A âˆˆ Î“ â†’ âˆ€ {Î”} â†’ Coná´º Î“ Î” â†’ Tyá´º A Î”
âˆˆá´º vz     (Ïƒ , t) = t
âˆˆá´º (vs v) (Ïƒ , t) = âˆˆá´º v Ïƒ

-- âˆˆá´º-nat : âˆ€ {Î“ Î” Î£ A}(v : A âˆˆ Î£)(Ïƒá´º : Coná´º Î” Î£)(Î´ : OPE Î“ Î”) â†’ âˆˆá´º v (Coná´ºâ‚‘ Ïƒ Î´) â‰¡ Tyá´ºâ‚‘ Î´ (âˆˆá´º v Ïƒ)
-- âˆˆá´º-nat vz     (Ïƒ , t) Î´ = refl
-- âˆˆá´º-nat (vs v) (Ïƒ , t) Î´ = âˆˆá´º-nat v Ïƒ Î´

-- -- Tm
-- mutual
--   Tmá´º : âˆ€ {Î“ A} â†’ Tm Î“ A â†’ âˆ€ {Î”} â†’ Coná´º Î” Î“ â†’ Tyá´º A Î”
--   Tmá´º (var v)   Ïƒ = âˆˆá´º v Ïƒ
--   Tmá´º (lam t)   Ïƒ =
--       (Î» Î´ aá´º â†’ Tmá´º t (OPEá´º Î´ Ïƒ , aá´º))
--     , (Î» Î´ Î½ aá´º â†’
--           Tmá´º-nat t (OPEá´º Î´ Ïƒ , aá´º) Î½ â»Â¹
--         â—¾ (Î» x â†’ Tmá´º t (x , aá´º á´º[ Î½ ]â‚‘)) & (OPEá´ºâˆ˜ Î´ Î½ Ïƒ â»Â¹))
--   Tmá´º (app f a) Ïƒ = projâ‚ (Tmá´º f Ïƒ) idâ‚‘ (Tmá´º a Ïƒ)

--   Tmá´º-nat :
--     âˆ€ {Î“ Î” Î£ A}(t : Tm Î“ A)(Ïƒ : Coná´º Î£ Î“)(Î´ : OPE Î” Î£)
--     â†’ Tmá´º t (OPEá´º Î´ Ïƒ) â‰¡ Tmá´º t Ïƒ á´º[ Î´ ]â‚‘
--   Tmá´º-nat (var v)   Ïƒ Î´ = âˆˆá´º-nat v Ïƒ Î´
--   Tmá´º-nat (lam t)   Ïƒ Î´ = â‡’á´º= (Î» Î½ aá´º â†’ (Î» x â†’ Tmá´º t (x , aá´º)) & (OPEá´ºâˆ˜ Î´ Î½ Ïƒ â»Â¹))
--   Tmá´º-nat (app f a) Ïƒ Î´
--     rewrite projâ‚ & Tmá´º-nat f Ïƒ Î´ | Tmá´º-nat a Ïƒ Î´
--     = (Î» x â†’ projâ‚ (Tmá´º f Ïƒ) x (Tmá´º a Ïƒ á´º[ Î´ ]â‚‘)) & (idrâ‚‘ Î´ â—¾ idlâ‚‘ Î´ â»Â¹)
--      â—¾ projâ‚‚ (Tmá´º f Ïƒ) idâ‚‘ Î´ (Tmá´º a Ïƒ) â»Â¹

-- mutual
--   qá´º : âˆ€ {Î“ A} â†’ Tmá´º Î“ A â†’ Nf Î“ A
--   qá´º {A = Î¹}     t = t
--   qá´º {A = A â‡’ B} t = lam (qá´º (projâ‚ t wk (uá´º (var vz))))

--   qá´º-nat : âˆ€ {A Î“ Î”}(tá´º : Tmá´º Î“ A)(Ïƒ : OPE Î” Î“) â†’ qá´º tá´º [ Ïƒ ]Nfâ‚‘ â‰¡ qá´º (tá´º á´º[ Ïƒ ]â‚‘)
--   qá´º-nat {Î¹}     tá´º        Ïƒ = refl
--   qá´º-nat {A â‡’ B} (f , nat) Ïƒ = lam &
--       (qá´º-nat (f wk (uá´º (var vz))) (keep Ïƒ)
--     â—¾ qá´º &
--         (nat (drop idâ‚‘) (keep Ïƒ) (uá´º (var vz))
--       â—¾ (Î» x â†’ f (drop x) (uá´º (var vz) á´º[ keep Ïƒ ]â‚‘)) & (idlâ‚‘ Ïƒ â—¾ idrâ‚‘ Ïƒ â»Â¹)
--       â—¾ f (drop (Ïƒ âˆ˜â‚‘ idâ‚‘)) & uá´º-nat (var vz) (keep Ïƒ)))

--   uá´º : âˆ€ {Î“ A} â†’ Ne Î“ A â†’ Tmá´º Î“ A
--   uá´º {A = Î¹}     n = ne n
--   uá´º {A = A â‡’ B} n =
--     (Î» Î´ aá´º â†’ uá´º (app (n [ Î´ ]Neâ‚‘) (qá´º aá´º))) ,
--     (Î» Ïƒ Î´ aá´º â†’
--         uá´º-nat (app (n [ Ïƒ ]Neâ‚‘) (qá´º aá´º)) Î´
--       â—¾ (Î» x â†’ uá´º (app x (qá´º aá´º [ Î´ ]Nfâ‚‘))) & âˆ˜â‚‘Ne n Ïƒ Î´
--       â—¾ (Î» x â†’ uá´º (app (n [ Ïƒ âˆ˜â‚‘ Î´ ]Neâ‚‘) x)) & qá´º-nat aá´º Î´)

--   uá´º-nat : âˆ€ {A Î“ Î”} â†’ (n : Ne Î“ A) â†’ (Ïƒ : OPE Î” Î“) â†’ uá´º n á´º[ Ïƒ ]â‚‘ â‰¡ uá´º (n [ Ïƒ ]Neâ‚‘)
--   uá´º-nat {Î¹}     n Ïƒ = refl
--   uá´º-nat {A â‡’ B} n Ïƒ = â‡’á´º= (Î» Î´ aá´º â†’ (Î» x â†’ uá´º (app x (qá´º aá´º))) & âˆ˜â‚‘Ne n Ïƒ Î´ â»Â¹)

-- idá´ºâ‚› : âˆ€ {Î“} â†’ Tmsá´º Î“ Î“
-- idá´ºâ‚› {âˆ™}     = âˆ™
-- idá´ºâ‚› {Î“ , t} = idá´ºâ‚› {Î“} á´ºâˆ˜â‚‘ wk , uá´º (var vz)

-- nf : âˆ€ {Î“ A} â†’ Tm Î“ A â†’ Nf Î“ A
-- nf t = qá´º (Tmâ†‘á´º t idá´ºâ‚›)

--------------------------------------------------------------------------------

-- Tmsá´º : âˆ€ {Î“ Î”} â†’ Tms Î“ Î” â†’ âˆ€ {Î£} â†’ Coná´º Î£ Î“ â†’ Coná´º Î£ Î”
-- Tmsá´º âˆ™       Î´ = âˆ™
-- Tmsá´º (Ïƒ , t) Î´ = Tmsá´º Ïƒ Î´ , Tmá´º t Î´

-- _â‚›âˆ˜á´º_ : âˆ€ {Î“ Î” Î£} â†’ Tms Î“ Î” â†’ Tmsá´º Î£ Î“ â†’ Tmsá´º Î£ Î”
-- âˆ™       â‚›âˆ˜á´º Î´ = âˆ™
-- (Ïƒ , t) â‚›âˆ˜á´º Î´ = (Ïƒ â‚›âˆ˜á´º Î´) , Tmâ†‘á´º t Î´

-- idâ‚‘Tmá´º : âˆ€ {Î“ A}(t : Tmá´º Î“ A) â†’ t á´º[ idâ‚‘ ]â‚‘ â‰¡ t
-- idâ‚‘Tmá´º {A = Î¹}     t = idâ‚‘Nf t
-- idâ‚‘Tmá´º {A = A â‡’ B} t = â‡’á´º= Î» Ïƒ aá´º â†’ (Î» x â†’ projâ‚ t x aá´º) & idlâ‚‘ Ïƒ

-- idrá´ºâ‚‘ : âˆ€ {Î“ Î”}(Ïƒ : Tmsá´º Î“ Î”) â†’ Ïƒ á´ºâˆ˜â‚‘ idâ‚‘ â‰¡ Ïƒ
-- idrá´ºâ‚‘ âˆ™       = refl
-- idrá´ºâ‚‘ (Ïƒ , t) = _,_ & idrá´ºâ‚‘ Ïƒ âŠ— idâ‚‘Tmá´º t

-- infixr 6 _â‚‘âˆ˜á´º_
-- _â‚‘âˆ˜á´º_ : âˆ€ {Î“ Î” Î£} â†’ OPE Î“ Î” â†’ Tmsá´º Î£ Î“ â†’ Tmsá´º Î£ Î”
-- âˆ™      â‚‘âˆ˜á´º Î´       = Î´
-- drop Ïƒ â‚‘âˆ˜á´º (Î´ , t) = Ïƒ â‚‘âˆ˜á´º Î´
-- keep Ïƒ â‚‘âˆ˜á´º (Î´ , t) = (Ïƒ â‚‘âˆ˜á´º Î´) , t

-- âˆˆâ†‘á´º-natâ‚ :
--   âˆ€ {Î“ Î” Î£ A}(v : A âˆˆ Î“)(Ïƒ : OPE Î” Î“)(Î´ : Tmsá´º Î£ Î”)
--   â†’ âˆˆâ†‘á´º (v [ Ïƒ ]âˆˆâ‚‘) Î´ â‰¡ âˆˆâ†‘á´º v (Ïƒ â‚‘âˆ˜á´º Î´)
-- âˆˆâ†‘á´º-natâ‚ ()     âˆ™        Î´
-- âˆˆâ†‘á´º-natâ‚ v      (drop Ïƒ) (Î´ , t) = âˆˆâ†‘á´º-natâ‚ v Ïƒ Î´
-- âˆˆâ†‘á´º-natâ‚ vz     (keep Ïƒ) (Î´ , t) = refl
-- âˆˆâ†‘á´º-natâ‚ (vs v) (keep Ïƒ) (Î´ , t) = âˆˆâ†‘á´º-natâ‚ v Ïƒ Î´

-- assâ‚‘á´ºâ‚‘ :
--   âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î£ Î)(Î´ : Tmsá´º Î” Î£)(Î½ : OPE Î“ Î”)
--   â†’ (Ïƒ â‚‘âˆ˜á´º Î´) á´ºâˆ˜â‚‘ Î½ â‰¡ Ïƒ â‚‘âˆ˜á´º Î´ á´ºâˆ˜â‚‘ Î½
-- assâ‚‘á´ºâ‚‘ âˆ™        Î´       Î½ = refl
-- assâ‚‘á´ºâ‚‘ (drop Ïƒ) (Î´ , t) Î½ = assâ‚‘á´ºâ‚‘ Ïƒ Î´ Î½
-- assâ‚‘á´ºâ‚‘ (keep Ïƒ) (Î´ , t) Î½ = (_, t á´º[ Î½ ]â‚‘) & assâ‚‘á´ºâ‚‘ Ïƒ Î´ Î½

-- Tmâ†‘á´º-natâ‚ :
--   âˆ€ {Î“ Î” Î£ A}(t : Tm Î“ A)(Ïƒ : OPE Î” Î“)(Î´ : Tmsá´º Î£ Î”)
--   â†’ Tmâ†‘á´º (t [ Ïƒ ]â‚‘) Î´ â‰¡ Tmâ†‘á´º t (Ïƒ â‚‘âˆ˜á´º Î´)
-- Tmâ†‘á´º-natâ‚ (var v)   Ïƒ Î´ = âˆˆâ†‘á´º-natâ‚ v Ïƒ Î´
-- Tmâ†‘á´º-natâ‚ (lam t)   Ïƒ Î´ = â‡’á´º= Î» Î½ aá´º â†’
--     Tmâ†‘á´º-natâ‚ t (keep Ïƒ) (Î´ á´ºâˆ˜â‚‘ Î½ , aá´º)
--   â—¾ (Î» x â†’ Tmâ†‘á´º t (x , aá´º)) & (assâ‚‘á´ºâ‚‘ Ïƒ Î´ Î½ â»Â¹)
-- Tmâ†‘á´º-natâ‚ (app f a) Ïƒ Î´
--   rewrite Tmâ†‘á´º-natâ‚ f Ïƒ Î´ | Tmâ†‘á´º-natâ‚ a Ïƒ Î´ = refl

-- idlá´ºâ‚‘ : âˆ€ {Î“ Î”}(Ïƒ : Tmsá´º Î“ Î”) â†’ idâ‚‘ â‚‘âˆ˜á´º Ïƒ â‰¡ Ïƒ
-- idlá´ºâ‚‘ âˆ™       = refl
-- idlá´ºâ‚‘ (Ïƒ , t) = (_, t) & idlá´ºâ‚‘ Ïƒ

-- assâ‚›â‚‘á´º :
--   âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Tms Î£ Î)(Î´ : OPE Î” Î£)(Î½ : Tmsá´º Î“ Î”)
--   â†’ (Ïƒ â‚›âˆ˜â‚‘ Î´) â‚›âˆ˜á´º Î½ â‰¡ Ïƒ â‚›âˆ˜á´º Î´ â‚‘âˆ˜á´º Î½
-- assâ‚›â‚‘á´º âˆ™       Î´ Î½ = refl
-- assâ‚›â‚‘á´º (Ïƒ , t) Î´ Î½ = _,_ & assâ‚›â‚‘á´º Ïƒ Î´ Î½ âŠ— Tmâ†‘á´º-natâ‚ t Î´ Î½

-- assâ‚›á´ºâ‚‘ :
--   âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Tms Î£ Î)(Î´ : Tmsá´º Î” Î£)(Î½ : OPE Î“ Î”)
--   â†’ (Ïƒ â‚›âˆ˜á´º Î´) á´ºâˆ˜â‚‘ Î½ â‰¡ Ïƒ â‚›âˆ˜á´º Î´ á´ºâˆ˜â‚‘ Î½
-- assâ‚›á´ºâ‚‘ âˆ™       Î´ Î½ = refl
-- assâ‚›á´ºâ‚‘ (Ïƒ , t) Î´ Î½ = _,_ & assâ‚›á´ºâ‚‘ Ïƒ Î´ Î½ âŠ— (Tmâ†‘á´º-nat t Î´ Î½ â»Â¹)

-- idlá´ºâ‚› : âˆ€ {Î“ Î”}(Ïƒ : Tmsá´º Î“ Î”) â†’ Ïƒ â‰¡ idâ‚› â‚›âˆ˜á´º Ïƒ
-- idlá´ºâ‚› âˆ™       = refl
-- idlá´ºâ‚› (Ïƒ , t) =
--   (_, t) & (((idlá´ºâ‚‘ Ïƒ â»Â¹ â—¾ idlá´ºâ‚› (idâ‚‘ â‚‘âˆ˜á´º Ïƒ)) â—¾ assâ‚›â‚‘á´º idâ‚› wk (Ïƒ , t) â»Â¹))

-- â‚›âˆ˜á´ºâˆˆâ†‘ :
--   âˆ€ {Î“ Î” Î£ A}(v : A âˆˆ Î”)(Ïƒ : Tms Î“ Î”)(Î´ : Tmsá´º Î£ Î“)
--   â†’ Tmâ†‘á´º (v [ Ïƒ ]âˆˆ) Î´ â‰¡ âˆˆâ†‘á´º v (Ïƒ â‚›âˆ˜á´º Î´)
-- â‚›âˆ˜á´ºâˆˆâ†‘ vz     (Ïƒ , t) Î´ = refl
-- â‚›âˆ˜á´ºâˆˆâ†‘ (vs v) (Ïƒ , t) Î´ = â‚›âˆ˜á´ºâˆˆâ†‘ v Ïƒ Î´

-- â‚›âˆ˜á´ºâ†‘ :
--   âˆ€ {Î“ Î” Î£ A}(t : Tm Î” A)(Ïƒ : Tms Î“ Î”)(Î´ : Tmsá´º Î£ Î“)
--   â†’ Tmâ†‘á´º (t [ Ïƒ ]) Î´ â‰¡ Tmâ†‘á´º t (Ïƒ â‚›âˆ˜á´º Î´)
-- â‚›âˆ˜á´ºâ†‘ (var v)   Ïƒ Î´ = â‚›âˆ˜á´ºâˆˆâ†‘ v Ïƒ Î´
-- â‚›âˆ˜á´ºâ†‘ (lam t)   Ïƒ Î´ = â‡’á´º= Î» Î½ aá´º â†’ 
--     â‚›âˆ˜á´ºâ†‘ t (keepâ‚› Ïƒ) (Î´ á´ºâˆ˜â‚‘ Î½ , aá´º)
--   â—¾ (Î» x â†’ Tmâ†‘á´º t ((x , aá´º))) &
--       (assâ‚›â‚‘á´º Ïƒ wk (Î´ á´ºâˆ˜â‚‘ Î½ , aá´º)
--     â—¾ (Ïƒ â‚›âˆ˜á´º_) & idlá´ºâ‚‘ (Î´ á´ºâˆ˜â‚‘ Î½)
--     â—¾ assâ‚›á´ºâ‚‘ Ïƒ Î´ Î½ â»Â¹)
-- â‚›âˆ˜á´ºâ†‘ (app f a) Ïƒ Î´
--   rewrite â‚›âˆ˜á´ºâ†‘ f Ïƒ Î´ | â‚›âˆ˜á´ºâ†‘ a Ïƒ Î´ = refl



