{-# OPTIONS --without-K #-}

-- everything in one module (don't ask why)
-- slightly shorter version where we define A âˆˆ Î“ as OPE Î“ (âˆ™ , A)

open import Lib
open import UIP

data Ty : Set where
  Î¹   : Ty
  _â‡’_ : Ty â†’ Ty â†’ Ty

data Con : Set where
  âˆ™   : Con
  _,_ : Con â†’ Ty â†’ Con

data OPE : Con â†’ Con â†’ Set where
  âˆ™    : OPE âˆ™ âˆ™
  drop : âˆ€ {A Î“ Î”} â†’ OPE Î“ Î” â†’ OPE (Î“ , A) Î”
  keep : âˆ€ {A Î“ Î”} â†’ OPE Î“ Î” â†’ OPE (Î“ , A) (Î” , A)

infix 3 _âˆˆ_
_âˆˆ_ : Ty â†’ Con â†’ Set
A âˆˆ Î“ = OPE Î“ (âˆ™ , A)

data Tm Î“ : Ty â†’ Set where
  var : âˆ€ {A} â†’ A âˆˆ Î“ â†’ Tm Î“ A
  lam : âˆ€ {A B} â†’ Tm (Î“ , A) B â†’ Tm Î“ (A â‡’ B)
  app : âˆ€ {A B} â†’ (f : Tm Î“ (A â‡’ B)) â†’ (a : Tm Î“ A) â†’ Tm Î“ B

--------------------------------------------------------------------------------

idâ‚‘ : âˆ€ {Î“} â†’ OPE Î“ Î“
idâ‚‘ {âˆ™}     = âˆ™
idâ‚‘ {Î“ , A} = keep (idâ‚‘ {Î“})

wk : âˆ€ {A Î“} â†’ OPE (Î“ , A) Î“
wk = drop idâ‚‘

infixr 6 _âˆ˜â‚‘_
_âˆ˜â‚‘_ : âˆ€ {Î“ Î” Î£} â†’ OPE Î” Î£ â†’ OPE Î“ Î” â†’ OPE Î“ Î£
Ïƒ      âˆ˜â‚‘ âˆ™      = Ïƒ
Ïƒ      âˆ˜â‚‘ drop Î´ = drop (Ïƒ âˆ˜â‚‘ Î´)
drop Ïƒ âˆ˜â‚‘ keep Î´ = drop (Ïƒ âˆ˜â‚‘ Î´)
keep Ïƒ âˆ˜â‚‘ keep Î´ = keep (Ïƒ âˆ˜â‚‘ Î´)

idlâ‚‘ : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ idâ‚‘ âˆ˜â‚‘ Ïƒ â‰¡ Ïƒ
idlâ‚‘ âˆ™        = refl
idlâ‚‘ (drop Ïƒ) = drop & idlâ‚‘ Ïƒ
idlâ‚‘ (keep Ïƒ) = keep & idlâ‚‘ Ïƒ

idrâ‚‘ : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ Ïƒ âˆ˜â‚‘ idâ‚‘ â‰¡ Ïƒ
idrâ‚‘ âˆ™        = refl
idrâ‚‘ (drop Ïƒ) = drop & idrâ‚‘ Ïƒ
idrâ‚‘ (keep Ïƒ) = keep & idrâ‚‘ Ïƒ

assâ‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î£ Î)(Î´ : OPE Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ âˆ˜â‚‘ Î´) âˆ˜â‚‘ Î½ â‰¡ Ïƒ âˆ˜â‚‘ (Î´ âˆ˜â‚‘ Î½)
assâ‚‘ Ïƒ        Î´        âˆ™        = refl
assâ‚‘ Ïƒ        Î´        (drop Î½) = drop & assâ‚‘ Ïƒ Î´ Î½
assâ‚‘ Ïƒ        (drop Î´) (keep Î½) = drop & assâ‚‘ Ïƒ Î´ Î½
assâ‚‘ (drop Ïƒ) (keep Î´) (keep Î½) = drop & assâ‚‘ Ïƒ Î´ Î½
assâ‚‘ (keep Ïƒ) (keep Î´) (keep Î½) = keep & assâ‚‘ Ïƒ Î´ Î½

Tmâ‚‘ : âˆ€ {A Î“ Î”} â†’ OPE Î“ Î” â†’ Tm Î” A â†’ Tm Î“ A
Tmâ‚‘ Ïƒ (var v)   = var (v âˆ˜â‚‘ Ïƒ)
Tmâ‚‘ Ïƒ (lam t)   = lam (Tmâ‚‘ (keep Ïƒ) t)
Tmâ‚‘ Ïƒ (app f a) = app (Tmâ‚‘ Ïƒ f) (Tmâ‚‘ Ïƒ a)

Tm-idâ‚‘ : âˆ€ {A Î“}(t : Tm Î“ A) â†’ Tmâ‚‘ idâ‚‘ t â‰¡ t
Tm-idâ‚‘ (var v)   = var & idrâ‚‘ v
Tm-idâ‚‘ (lam t)   = lam & Tm-idâ‚‘ t
Tm-idâ‚‘ (app f a) = app & Tm-idâ‚‘ f âŠ— Tm-idâ‚‘ a

Tm-âˆ˜â‚‘ : âˆ€ {A Î“ Î” Î£}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) t â‰¡ Tmâ‚‘ Î´ (Tmâ‚‘ Ïƒ t)
Tm-âˆ˜â‚‘ Ïƒ Î´ (var v)   = var & (assâ‚‘ v Ïƒ Î´ â»Â¹)
Tm-âˆ˜â‚‘ Ïƒ Î´ (lam t)   = lam & Tm-âˆ˜â‚‘ (keep Ïƒ) (keep Î´) t
Tm-âˆ˜â‚‘ Ïƒ Î´ (app f a) = app & Tm-âˆ˜â‚‘ Ïƒ Î´ f âŠ— Tm-âˆ˜â‚‘ Ïƒ Î´ a

--------------------------------------------------------------------------------

infixr 6 _â‚‘âˆ˜â‚›_ _â‚›âˆ˜â‚‘_ _âˆ˜â‚›_

Sub : Con â†’ Con â†’ Set
Sub Î“ âˆ™       = âŠ¤
Sub Î“ (Î” , A) = Sub Î“ Î” Ã— Tm Î“ A

_â‚›âˆ˜â‚‘_ : âˆ€ {Î“ Î” Î£} â†’ Sub Î” Î£ â†’ OPE Î“ Î” â†’ Sub Î“ Î£
_â‚›âˆ˜â‚‘_ {Î£ = âˆ™}     Ïƒ Î´ = tt
_â‚›âˆ˜â‚‘_ {Î£ = Î£ , A} Ïƒ Î´ = projâ‚ Ïƒ â‚›âˆ˜â‚‘ Î´ , Tmâ‚‘ Î´ (projâ‚‚ Ïƒ)

_â‚‘âˆ˜â‚›_ : âˆ€ {Î“ Î” Î£} â†’ OPE Î” Î£ â†’ Sub Î“ Î” â†’ Sub Î“ Î£
âˆ™      â‚‘âˆ˜â‚› Î´       = Î´
drop Ïƒ â‚‘âˆ˜â‚› (Î´ , t) = Ïƒ â‚‘âˆ˜â‚› Î´
keep Ïƒ â‚‘âˆ˜â‚› (Î´ , t) = Ïƒ â‚‘âˆ˜â‚› Î´ , t

dropâ‚› : âˆ€ {A Î“ Î”} â†’ Sub Î“ Î” â†’ Sub (Î“ , A) Î”
dropâ‚› Ïƒ = Ïƒ â‚›âˆ˜â‚‘ wk

Îµ : âˆ€ {Î“} â†’ OPE Î“ âˆ™
Îµ {âˆ™}     = âˆ™
Îµ {Î“ , _} = drop Îµ

ÎµÎ· : âˆ€ {Î“}(Ïƒ : OPE Î“ âˆ™) â†’ Ïƒ â‰¡ Îµ
ÎµÎ· âˆ™        = refl
ÎµÎ· (drop Ïƒ) = drop & ÎµÎ· Ïƒ

keepâ‚› : âˆ€ {A Î“ Î”} â†’ Sub Î“ Î” â†’ Sub (Î“ , A) (Î” , A)
keepâ‚› Ïƒ = dropâ‚› Ïƒ , var (keep Îµ)

âŒœ_âŒáµ’áµ–áµ‰ : âˆ€ {Î“ Î”} â†’ OPE Î“ Î” â†’ Sub Î“ Î”
âŒœ âˆ™      âŒáµ’áµ–áµ‰ = tt
âŒœ drop Ïƒ âŒáµ’áµ–áµ‰ = dropâ‚› âŒœ Ïƒ âŒáµ’áµ–áµ‰
âŒœ keep Ïƒ âŒáµ’áµ–áµ‰ = keepâ‚› âŒœ Ïƒ âŒáµ’áµ–áµ‰

Tmâ‚› : âˆ€ {A Î“ Î”} â†’ Sub Î“ Î” â†’ Tm Î” A â†’ Tm Î“ A
Tmâ‚› Ïƒ (var v)   = projâ‚‚ (v â‚‘âˆ˜â‚› Ïƒ)
Tmâ‚› Ïƒ (lam t)   = lam (Tmâ‚› (keepâ‚› Ïƒ) t)
Tmâ‚› Ïƒ (app f a) = app (Tmâ‚› Ïƒ f) (Tmâ‚› Ïƒ a)

idâ‚› : âˆ€ {Î“} â†’ Sub Î“ Î“
idâ‚› {âˆ™}     = tt
idâ‚› {Î“ , A} = keepâ‚› idâ‚›

_âˆ˜â‚›_ : âˆ€ {Î“ Î” Î£} â†’ Sub Î” Î£ â†’ Sub Î“ Î” â†’ Sub Î“ Î£
_âˆ˜â‚›_ {Î£ = âˆ™}     Ïƒ Î´ = tt
_âˆ˜â‚›_ {Î£ = Î£ , A} Ïƒ Î´ = projâ‚ Ïƒ âˆ˜â‚› Î´ , Tmâ‚› Î´ (projâ‚‚ Ïƒ)

assâ‚›â‚‘â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : OPE Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ â‚›âˆ˜â‚‘ Î´) â‚›âˆ˜â‚‘ Î½ â‰¡ Ïƒ â‚›âˆ˜â‚‘ (Î´ âˆ˜â‚‘ Î½)
assâ‚›â‚‘â‚‘ {Î = âˆ™}    _       Î´ Î½ = refl
assâ‚›â‚‘â‚‘ {Î = Î , A}(Ïƒ , t) Î´ Î½ = _,_ & assâ‚›â‚‘â‚‘ Ïƒ Î´ Î½ âŠ— (Tm-âˆ˜â‚‘ Î´ Î½ t â»Â¹)

assâ‚‘â‚›â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î£ Î)(Î´ : Sub Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ â‚‘âˆ˜â‚› Î´) â‚›âˆ˜â‚‘ Î½ â‰¡ Ïƒ â‚‘âˆ˜â‚› (Î´ â‚›âˆ˜â‚‘ Î½)
assâ‚‘â‚›â‚‘ âˆ™        Î´       Î½ = refl
assâ‚‘â‚›â‚‘ (drop Ïƒ) (Î´ , t) Î½ = assâ‚‘â‚›â‚‘ Ïƒ Î´ Î½
assâ‚‘â‚›â‚‘ (keep Ïƒ) (Î´ , t) Î½ = (_, Tmâ‚‘ Î½ t) & assâ‚‘â‚›â‚‘ Ïƒ Î´ Î½

idlâ‚‘â‚› : âˆ€ {Î“ Î”}(Ïƒ : Sub Î“ Î”) â†’ idâ‚‘ â‚‘âˆ˜â‚› Ïƒ â‰¡ Ïƒ
idlâ‚‘â‚› {Î” = âˆ™}    tt      = refl
idlâ‚‘â‚› {Î” = Î” , A}(Ïƒ , t) = (_, t) & idlâ‚‘â‚› Ïƒ

idlâ‚›â‚‘ : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ idâ‚› â‚›âˆ˜â‚‘ Ïƒ â‰¡ âŒœ Ïƒ âŒáµ’áµ–áµ‰
idlâ‚›â‚‘ âˆ™        = refl
idlâ‚›â‚‘ (drop Ïƒ) =
    (idâ‚› â‚›âˆ˜â‚‘_) & (drop & (idrâ‚‘ Ïƒ â»Â¹))
  â—¾ assâ‚›â‚‘â‚‘ idâ‚› Ïƒ wk â»Â¹
  â—¾ dropâ‚› & idlâ‚›â‚‘ Ïƒ
idlâ‚›â‚‘ (keep Ïƒ) =
  _,_ & (assâ‚›â‚‘â‚‘ idâ‚› wk (keep Ïƒ) â—¾ (idâ‚› â‚›âˆ˜â‚‘_) & (drop & (idlâ‚‘ Ïƒ)) â—¾ idlâ‚›â‚‘ (drop Ïƒ))
      âŠ— (var âˆ˜ keep) & ÎµÎ· _

idrâ‚‘â‚› : âˆ€ {Î“ Î”}(Ïƒ : OPE Î“ Î”) â†’ Ïƒ â‚‘âˆ˜â‚› idâ‚› â‰¡ âŒœ Ïƒ âŒáµ’áµ–áµ‰
idrâ‚‘â‚› âˆ™        = refl
idrâ‚‘â‚› (drop Ïƒ) = assâ‚‘â‚›â‚‘ Ïƒ idâ‚› wk â»Â¹ â—¾ dropâ‚› & idrâ‚‘â‚› Ïƒ
idrâ‚‘â‚› (keep Ïƒ) = (_, var (keep Îµ)) & (assâ‚‘â‚›â‚‘ Ïƒ idâ‚› wk â»Â¹ â—¾ (_â‚›âˆ˜â‚‘ wk) & idrâ‚‘â‚› Ïƒ)

assâ‚‘â‚‘â‚› :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î£ Î)(Î´ : OPE Î” Î£)(Î½ : Sub Î“ Î”)
  â†’ (Ïƒ âˆ˜â‚‘ Î´) â‚‘âˆ˜â‚› Î½ â‰¡ Ïƒ â‚‘âˆ˜â‚› (Î´ â‚‘âˆ˜â‚› Î½)
assâ‚‘â‚‘â‚› Ïƒ        âˆ™        Î½       = refl
assâ‚‘â‚‘â‚› Ïƒ        (drop Î´) (Î½ , t) = assâ‚‘â‚‘â‚› Ïƒ Î´ Î½
assâ‚‘â‚‘â‚› (drop Ïƒ) (keep Î´) (Î½ , t) = assâ‚‘â‚‘â‚› Ïƒ Î´ Î½
assâ‚‘â‚‘â‚› (keep Ïƒ) (keep Î´) (Î½ , t) = (_, t) & assâ‚‘â‚‘â‚› Ïƒ Î´ Î½

Tm-â‚‘âˆ˜â‚› : âˆ€ {A Î“ Î” Î£}(Ïƒ : OPE Î” Î£)(Î´ : Sub Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚› (Ïƒ â‚‘âˆ˜â‚› Î´) t â‰¡ Tmâ‚› Î´ (Tmâ‚‘ Ïƒ t)
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ (var v) = projâ‚‚ & assâ‚‘â‚‘â‚› v Ïƒ Î´ â»Â¹
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ (lam t) =
  lam & ((Î» x â†’ Tmâ‚› (x , var (keep Îµ)) t) & assâ‚‘â‚›â‚‘ Ïƒ Î´ wk â—¾ Tm-â‚‘âˆ˜â‚› (keep Ïƒ) (keepâ‚› Î´) t)
Tm-â‚‘âˆ˜â‚› Ïƒ Î´ (app f a) = app & Tm-â‚‘âˆ˜â‚› Ïƒ Î´ f âŠ— Tm-â‚‘âˆ˜â‚› Ïƒ Î´ a

Tm-â‚›âˆ˜â‚‘ : âˆ€ {Î“ Î” Î£ A}(Ïƒ : Sub Î” Î£)(Î´ : OPE Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚› (Ïƒ â‚›âˆ˜â‚‘ Î´) t â‰¡ Tmâ‚‘ Î´ (Tmâ‚› Ïƒ t)
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ (var x) = projâ‚‚ & assâ‚‘â‚›â‚‘ x Ïƒ Î´ â»Â¹
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ (lam t) =
  lam &
      ((Î» x â†’ Tmâ‚› (x , var (keep Îµ)) t) &
          (assâ‚›â‚‘â‚‘ Ïƒ Î´ wk
        â—¾ (Ïƒ â‚›âˆ˜â‚‘_) & (drop & (idrâ‚‘ Î´ â—¾ idlâ‚‘ Î´ â»Â¹))
        â—¾ assâ‚›â‚‘â‚‘ Ïƒ wk (keep Î´) â»Â¹)
    â—¾ (Î» x â†’ Tmâ‚› (((Ïƒ â‚›âˆ˜â‚‘ drop idâ‚‘) â‚›âˆ˜â‚‘ keep Î´) , var (keep x)) t)
        & (ÎµÎ· (Îµ âˆ˜â‚‘ Î´) â»Â¹)
    â—¾ Tm-â‚›âˆ˜â‚‘ (keepâ‚› Ïƒ) (keep Î´) t )
Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ (app f a) = app & Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ f âŠ— Tm-â‚›âˆ˜â‚‘ Ïƒ Î´ a

assâ‚›â‚‘â‚› :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : OPE Î” Î£)(Î½ : Sub Î“ Î”)
  â†’ (Ïƒ â‚›âˆ˜â‚‘ Î´) âˆ˜â‚› Î½ â‰¡ Ïƒ âˆ˜â‚› (Î´ â‚‘âˆ˜â‚› Î½)
assâ‚›â‚‘â‚› {Î = âˆ™}    tt      Î´ Î½ = refl
assâ‚›â‚‘â‚› {Î = Î , A}(Ïƒ , t) Î´ Î½ = _,_ & assâ‚›â‚‘â‚› Ïƒ Î´ Î½ âŠ— (Tm-â‚‘âˆ˜â‚› Î´ Î½ t â»Â¹)

assâ‚‘â‚›â‚› :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î£ Î)(Î´ : Sub Î” Î£)(Î½ : Sub Î“ Î”)
  â†’ (Ïƒ â‚‘âˆ˜â‚› Î´) âˆ˜â‚› Î½ â‰¡ Ïƒ â‚‘âˆ˜â‚› (Î´ âˆ˜â‚› Î½)
assâ‚‘â‚›â‚› âˆ™        Î´       Î½ = refl
assâ‚‘â‚›â‚› (drop Ïƒ) (Î´ , t) Î½ = assâ‚‘â‚›â‚› Ïƒ Î´ Î½
assâ‚‘â‚›â‚› (keep Ïƒ) (Î´ , t) Î½ = (_, Tmâ‚› Î½ t) & assâ‚‘â‚›â‚› Ïƒ Î´ Î½

assâ‚›â‚›â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : Sub Î” Î£)(Î½ : OPE Î“ Î”)
  â†’ (Ïƒ âˆ˜â‚› Î´) â‚›âˆ˜â‚‘ Î½ â‰¡ Ïƒ âˆ˜â‚› (Î´ â‚›âˆ˜â‚‘ Î½)
assâ‚›â‚›â‚‘ {Î = âˆ™}    tt      Î´ Î½ = refl
assâ‚›â‚›â‚‘ {Î = Î , A}(Ïƒ , t) Î´ Î½ = _,_ & assâ‚›â‚›â‚‘ Ïƒ Î´ Î½ âŠ— (Tm-â‚›âˆ˜â‚‘ Î´ Î½ t â»Â¹)

Tm-âˆ˜â‚› : âˆ€ {Î“ Î” Î£ A}(Ïƒ : Sub Î” Î£)(Î´ : Sub Î“ Î”)(t : Tm Î£ A) â†’ Tmâ‚› (Ïƒ âˆ˜â‚› Î´) t â‰¡ Tmâ‚› Î´ (Tmâ‚› Ïƒ t)
Tm-âˆ˜â‚› Ïƒ Î´ (var x) = projâ‚‚ & assâ‚‘â‚›â‚› x Ïƒ Î´ â»Â¹
Tm-âˆ˜â‚› Ïƒ Î´ (lam t) =
  lam &
      ((Î» x â†’ Tmâ‚› (x , var (keep Îµ)) t) &
          (assâ‚›â‚›â‚‘ Ïƒ Î´ wk
        â—¾ (Ïƒ âˆ˜â‚›_) & (idlâ‚‘â‚›  (dropâ‚› Î´) â»Â¹) â—¾ assâ‚›â‚‘â‚› Ïƒ wk (keepâ‚› Î´) â»Â¹)
    â—¾ Tm-âˆ˜â‚› (keepâ‚› Ïƒ) (keepâ‚› Î´) t)
Tm-âˆ˜â‚› Ïƒ Î´ (app f a) = app & Tm-âˆ˜â‚› Ïƒ Î´ f âŠ— Tm-âˆ˜â‚› Ïƒ Î´ a

projâ‚‚âŒœâŒ : âˆ€ {Î“ A}(x : A âˆˆ Î“) â†’ projâ‚‚ âŒœ x âŒáµ’áµ–áµ‰ â‰¡ var x
projâ‚‚âŒœâŒ (drop x) = Tmâ‚‘ wk & projâ‚‚âŒœâŒ x â—¾ (var âˆ˜ drop) & idrâ‚‘ x
projâ‚‚âŒœâŒ (keep x) = (var âˆ˜ keep) & (ÎµÎ· x â»Â¹)

Tm-idâ‚› : âˆ€ {A Î“}(t : Tm Î“ A) â†’ Tmâ‚› idâ‚› t â‰¡ t
Tm-idâ‚› (var v)   = projâ‚‚ & idrâ‚‘â‚› v â—¾ projâ‚‚âŒœâŒ v
Tm-idâ‚› (lam t)   = lam & Tm-idâ‚› t
Tm-idâ‚› (app f a) = app & Tm-idâ‚› f âŠ— Tm-idâ‚› a

idrâ‚› : âˆ€ {Î“ Î”}(Ïƒ : Sub Î“ Î”) â†’ Ïƒ âˆ˜â‚› idâ‚› â‰¡ Ïƒ
idrâ‚› {Î” = âˆ™}    tt      = refl
idrâ‚› {Î” = Î” , A}(Ïƒ , t) = _,_ & idrâ‚› Ïƒ âŠ— Tm-idâ‚› t

Î²â‚‘â‚› :
  âˆ€ {Î“ Î” Î£ A B}(Ïƒ : Sub Î” Î“)(Î½ : OPE Î£ Î”) (t : Tm (Î“ , A) B) (a : Tm Î£ A)
  â†’ Tmâ‚› (Ïƒ â‚›âˆ˜â‚‘ Î½ , a) t â‰¡ Tmâ‚› (idâ‚› , a) (Tmâ‚‘ (keep Î½) (Tmâ‚› (keepâ‚› Ïƒ) t))
Î²â‚‘â‚› Ïƒ Î½ t a =
    (Î» x â†’ Tmâ‚› (x , a) t) &
       (idrâ‚› (Ïƒ â‚›âˆ˜â‚‘ Î½) â»Â¹
      â—¾ assâ‚›â‚‘â‚› Ïƒ Î½ idâ‚›
      â—¾ (Ïƒ âˆ˜â‚›_) & idlâ‚‘â‚› (Î½ â‚‘âˆ˜â‚› idâ‚›) â»Â¹
      â—¾ assâ‚›â‚‘â‚› Ïƒ wk ((Î½ â‚‘âˆ˜â‚› idâ‚›) , a) â»Â¹)
  â—¾ Tm-âˆ˜â‚› (keepâ‚› Ïƒ) (keep Î½ â‚‘âˆ˜â‚› (idâ‚› , a)) t
  â—¾ Tm-â‚‘âˆ˜â‚› (keep Î½) (idâ‚› , a) (Tmâ‚› (keepâ‚› Ïƒ) t)

--------------------------------------------------------------------------------

mutual
  data Nf (Î“ : Con) : Ty â†’ Set where
    ne  : Ne Î“ Î¹ â†’ Nf Î“ Î¹
    lam : âˆ€ {A B} â†’ Nf (Î“ , A) B â†’ Nf Î“ (A â‡’ B)

  data Ne (Î“ : Con) : Ty â†’ Set where
    var : âˆ€ {A} â†’ A âˆˆ Î“ â†’ Ne Î“ A
    app : âˆ€ {A B} â†’ Ne Î“ (A â‡’ B) â†’ Nf Î“ A â†’ Ne Î“ B

mutual
  Nfâ‚‘ : âˆ€ {Î“ Î” A} â†’ OPE Î“ Î” â†’ Nf Î” A â†’ Nf Î“ A
  Nfâ‚‘ Ïƒ (ne n)  = ne (Neâ‚‘ Ïƒ n)
  Nfâ‚‘ Ïƒ (lam n) = lam (Nfâ‚‘ (keep Ïƒ) n)

  Neâ‚‘ : âˆ€ {Î“ Î” A} â†’ OPE Î“ Î” â†’ Ne Î” A â†’ Ne Î“ A
  Neâ‚‘ Ïƒ (var v)   = var (v âˆ˜â‚‘ Ïƒ)
  Neâ‚‘ Ïƒ (app f a) = app (Neâ‚‘ Ïƒ f) (Nfâ‚‘ Ïƒ a)

mutual
  âŒœ_âŒ : âˆ€ {Î“ A} â†’ Nf Î“ A â†’ Tm Î“ A
  âŒœ ne n  âŒ = âŒœ n âŒNe
  âŒœ lam t âŒ = lam âŒœ t âŒ

  âŒœ_âŒNe : âˆ€ {Î“ A} â†’ Ne Î“ A â†’ Tm Î“ A
  âŒœ var v   âŒNe = var v
  âŒœ app n t âŒNe = app âŒœ n âŒNe âŒœ t âŒ

mutual
  âŒœâŒNe-nat : âˆ€ {Î“ Î” A}(Ïƒ : OPE Î” Î“)(n : Ne Î“ A) â†’ âŒœ Neâ‚‘ Ïƒ n âŒNe â‰¡ Tmâ‚‘ Ïƒ âŒœ n âŒNe
  âŒœâŒNe-nat Ïƒ (var v)   = refl
  âŒœâŒNe-nat Ïƒ (app f a) = app & âŒœâŒNe-nat Ïƒ f âŠ— âŒœâŒNf-nat Ïƒ a

  âŒœâŒNf-nat : âˆ€ {Î“ Î” A}(Ïƒ : OPE Î” Î“)(n : Nf Î“ A) â†’ âŒœ Nfâ‚‘ Ïƒ n âŒ â‰¡ Tmâ‚‘ Ïƒ âŒœ n âŒ
  âŒœâŒNf-nat Ïƒ (ne n)  = âŒœâŒNe-nat Ïƒ n
  âŒœâŒNf-nat Ïƒ (lam n) = lam & âŒœâŒNf-nat (keep Ïƒ) n

mutual
  Nf-âˆ˜â‚‘ :
    âˆ€ {Î“ Î” Î£ A}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(t : Nf Î£ A)
    â†’ Nfâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) t â‰¡ Nfâ‚‘ Î´ (Nfâ‚‘ Ïƒ t)
  Nf-âˆ˜â‚‘  Ïƒ Î´ (ne n)  = ne & Ne-âˆ˜â‚‘ Ïƒ Î´ n
  Nf-âˆ˜â‚‘  Ïƒ Î´ (lam t) = lam & Nf-âˆ˜â‚‘ (keep Ïƒ) (keep Î´) t

  Ne-âˆ˜â‚‘ :
    âˆ€ {Î“ Î” Î£ A}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(t : Ne Î£ A)
    â†’ Neâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) t â‰¡ Neâ‚‘ Î´ (Neâ‚‘ Ïƒ t)
  Ne-âˆ˜â‚‘ Ïƒ Î´ (var v)   = var & (assâ‚‘ v Ïƒ Î´ â»Â¹)
  Ne-âˆ˜â‚‘ Ïƒ Î´ (app f a) = app & Ne-âˆ˜â‚‘ Ïƒ Î´ f âŠ— Nf-âˆ˜â‚‘ Ïƒ Î´ a

mutual
  Nf-idâ‚‘ : âˆ€ {Î“ A}(t : Nf Î“ A) â†’ Nfâ‚‘ idâ‚‘ t â‰¡ t
  Nf-idâ‚‘ (ne n)  = ne & Ne-idâ‚‘ n
  Nf-idâ‚‘ (lam t) = lam & Nf-idâ‚‘ t

  Ne-idâ‚‘ : âˆ€ {Î“ A}(t : Ne Î“ A) â†’ Neâ‚‘ idâ‚‘ t â‰¡ t
  Ne-idâ‚‘ (var v)   = var & idrâ‚‘ v
  Ne-idâ‚‘ (app f a) = app & Ne-idâ‚‘ f âŠ— Nf-idâ‚‘ a

--------------------------------------------------------------------------------

data _~_ {Î“} : âˆ€ {A} â†’ Tm Î“ A â†’ Tm Î“ A â†’ Set where
  Î·     : âˆ€ {A B}(t : Tm Î“ (A â‡’ B))     â†’  t ~ lam (app (Tmâ‚‘ wk t) (var (keep Îµ)))
  Î²     : âˆ€ {A B}(t : Tm (Î“ , A) B) t'  â†’  app (lam t) t' ~ Tmâ‚› (idâ‚› , t') t

  lam   : âˆ€ {A B}{t t' : Tm (Î“ , A) B}       â†’ t ~ t' â†’  lam t   ~ lam t'
  app   : âˆ€ {A B}{f f' : Tm Î“ (A â‡’ B)}{a a'} â†’ f ~ f' â†’  a ~ a' â†’ app f a ~ app f' a'
  ~refl : âˆ€ {A}{t : Tm Î“ A}                  â†’ t ~ t
  _~â»Â¹  : âˆ€ {A}{t t' : Tm Î“ A}               â†’ t ~ t' â†’ t' ~ t
  _~â—¾_  : âˆ€ {A}{t t' t'' : Tm Î“ A}           â†’ t ~ t' â†’ t' ~ t'' â†’ t ~ t''

infix 3 _~_
infixl 4 _~â—¾_
infix 6 _~â»Â¹

~â‚‘ : âˆ€ {Î“ Î” A}{t t' : Tm Î“ A}(Ïƒ : OPE Î” Î“) â†’ t ~ t' â†’ Tmâ‚‘ Ïƒ t ~ Tmâ‚‘ Ïƒ t'
~â‚‘ Ïƒ (Î· t) =
  coe ((Î» t' â†’ Tmâ‚‘ Ïƒ t ~ lam (app t' (var (keep Îµ))))
    & (Tm-âˆ˜â‚‘ Ïƒ wk t â»Â¹
    â—¾ (Î» x â†’ Tmâ‚‘ (drop x) t) & (idrâ‚‘ Ïƒ â—¾ idlâ‚‘ Ïƒ â»Â¹)
    â—¾ Tm-âˆ˜â‚‘ wk  (keep Ïƒ) t)
    â—¾ (Î» x â†’ (Tmâ‚‘ Ïƒ t ~ lam (app (Tmâ‚‘ (keep Ïƒ) (Tmâ‚‘ wk t)) (var (keep x)))))
        & (ÎµÎ· (Îµ âˆ˜â‚‘ Ïƒ) â»Â¹))
  (Î· (Tmâ‚‘ Ïƒ t))

~â‚‘ Ïƒ (Î² t t') =
  coe ((app (lam (Tmâ‚‘ (keep Ïƒ) t)) (Tmâ‚‘ Ïƒ t') ~_) &
    (Tm-â‚‘âˆ˜â‚› (keep Ïƒ) (idâ‚› , Tmâ‚‘ Ïƒ t') t â»Â¹
    â—¾ (Î» x â†’ Tmâ‚› (x , Tmâ‚‘ Ïƒ t') t) & (idrâ‚‘â‚› Ïƒ â—¾ idlâ‚›â‚‘ Ïƒ â»Â¹)
    â—¾ Tm-â‚›âˆ˜â‚‘ (idâ‚› , t') Ïƒ t))
  (Î² (Tmâ‚‘ (keep Ïƒ) t) (Tmâ‚‘ Ïƒ t'))

~â‚‘ Ïƒ (lam t~t')       = lam (~â‚‘ (keep Ïƒ) t~t')
~â‚‘ Ïƒ (app t~t' a~a')  = app (~â‚‘ Ïƒ t~t') (~â‚‘ Ïƒ a~a')
~â‚‘ Ïƒ ~refl            = ~refl
~â‚‘ Ïƒ (t~t' ~â»Â¹)       = ~â‚‘ Ïƒ t~t' ~â»Â¹
~â‚‘ Ïƒ (t~t' ~â—¾ t'~t'') = ~â‚‘ Ïƒ t~t' ~â—¾ ~â‚‘ Ïƒ t'~t''

-- Tyá´º A : PSh ğ’ªPE
--------------------------------------------------------------------------------
mutual
  Tyá´º : Ty â†’ Con â†’ Set
  Tyá´º Î¹       Î“ = Nf Î“ Î¹
  Tyá´º (A â‡’ B) Î“ =
    Î£ (âˆ€ {Î”} â†’ OPE Î” Î“ â†’ Tyá´º A Î” â†’ Tyá´º B Î”) Î» fá´º â†’
    âˆ€ {Î” Î£}(Ïƒ : OPE Î” Î“)(Î´ : OPE Î£ Î”) aá´º â†’ fá´º (Ïƒ âˆ˜â‚‘ Î´) (Tyá´ºâ‚‘ Î´ aá´º) â‰¡ Tyá´ºâ‚‘ Î´ (fá´º Ïƒ aá´º)

  Tyá´ºâ‚‘ : âˆ€ {A Î“ Î”} â†’ OPE Î” Î“ â†’ Tyá´º A Î“ â†’ Tyá´º A Î”
  Tyá´ºâ‚‘ {Î¹}     Ïƒ tá´º            = Nfâ‚‘ Ïƒ tá´º
  Tyá´ºâ‚‘ {A â‡’ B} Ïƒ (tá´º , tá´º-nat) =
    (Î» Î´ â†’ tá´º (Ïƒ âˆ˜â‚‘ Î´)) ,
    (Î» Î´ Î½ aá´º â†’ (Î» x â†’ tá´º x (Tyá´ºâ‚‘ Î½ aá´º)) & (assâ‚‘ Ïƒ Î´ Î½ â»Â¹) â—¾ tá´º-nat (Ïƒ âˆ˜â‚‘ Î´) Î½ aá´º)

â‡’á´ºâ‰¡ :
  âˆ€ {Î“ A B}{f f' : Tyá´º (A â‡’ B) Î“}
  â†’ (âˆ€ {Î”}(Ïƒ : OPE Î” Î“) a â†’ projâ‚ f Ïƒ a â‰¡ projâ‚ f' Ïƒ a)
  â†’ f â‰¡ f'
â‡’á´ºâ‰¡ {f = f}{f'} eq = ,Î£=
  (funexti Î» _ â†’ funext Î» Ïƒ â†’ funext Î» aá´º â†’ eq Ïƒ aá´º )
  (funexti Î» _ â†’ funexti Î» _ â†’ funext Î» _ â†’ funext Î» _ â†’ funext Î» _ â†’ UIP _ _)

Tyá´º-idâ‚‘ : âˆ€ {Î“ A}(tá´º : Tyá´º A Î“) â†’ Tyá´ºâ‚‘ idâ‚‘ tá´º â‰¡ tá´º
Tyá´º-idâ‚‘ {A = Î¹}     tá´º       = Nf-idâ‚‘ tá´º
Tyá´º-idâ‚‘ {A = A â‡’ B} (tá´º , _) = â‡’á´ºâ‰¡ Î» Ïƒ aá´º â†’ (Î» x â†’ tá´º x aá´º) & idlâ‚‘ Ïƒ

Tyá´º-âˆ˜â‚‘ :
  âˆ€ {Î“ Î” Î£ A}(tá´º : Tyá´º A Î£)(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)
  â†’ Tyá´ºâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) tá´º â‰¡ Tyá´ºâ‚‘ Î´ (Tyá´ºâ‚‘ Ïƒ tá´º)
Tyá´º-âˆ˜â‚‘ {A = Î¹}     tá´º       Ïƒ Î´ = Nf-âˆ˜â‚‘ Ïƒ Î´ tá´º
Tyá´º-âˆ˜â‚‘ {A = A â‡’ B} (tá´º , _) Ïƒ Î´ = â‡’á´ºâ‰¡ Î» Î½ aá´º â†’ (Î» x â†’ tá´º x aá´º) & assâ‚‘ Ïƒ Î´ Î½

-- Coná´º Î“ : PSh ğ’ªPE
--------------------------------------------------------------------------------

Coná´º : Con â†’ Con â†’ Set
Coná´º âˆ™       Î” = âŠ¤
Coná´º (Î“ , A) Î” = Coná´º Î“ Î” Ã— Tyá´º A Î”

Coná´ºâ‚‘ : âˆ€ {Î“ Î”} â†’ OPE Î” Î“ â†’ âˆ€ {Î£} â†’ Coná´º Î£ Î“ â†’ Coná´º Î£ Î”
Coná´ºâ‚‘ Ïƒ {âˆ™}    tt       = tt
Coná´ºâ‚‘ Ïƒ {Î£ , A}(Î´ , tá´º) = Coná´ºâ‚‘ Ïƒ Î´ , Tyá´ºâ‚‘ Ïƒ tá´º

Coná´º-idâ‚‘ : âˆ€ {Î“ Î”}(Ïƒá´º : Coná´º Î“ Î”) â†’ Coná´ºâ‚‘ idâ‚‘ Ïƒá´º â‰¡ Ïƒá´º
Coná´º-idâ‚‘ {âˆ™}    tt       = refl
Coná´º-idâ‚‘ {Î“ , A}(Ïƒá´º , t) = _,_ & Coná´º-idâ‚‘ Ïƒá´º âŠ— Tyá´º-idâ‚‘ t

Coná´º-âˆ˜â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(Î½ : Coná´º Î Î£)
  â†’ Coná´ºâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) Î½ â‰¡ Coná´ºâ‚‘ Î´ (Coná´ºâ‚‘ Ïƒ Î½)
Coná´º-âˆ˜â‚‘ {Î = âˆ™}     Ïƒ Î´ tt      = refl
Coná´º-âˆ˜â‚‘ {Î = Î , A} Ïƒ Î´ (Î½ , t) = _,_ & Coná´º-âˆ˜â‚‘ Ïƒ Î´ Î½ âŠ— Tyá´º-âˆ˜â‚‘ t Ïƒ Î´

-- OPEá´º {Î“}{Î”} Ïƒ : PSh ğ’ªPE (Coná´º Î“, Coná´º Î”)
--------------------------------------------------------------------------------
OPEá´º : âˆ€ {Î“ Î”} â†’ OPE Î“ Î” â†’ âˆ€ {Î£} â†’ Coná´º Î“ Î£ â†’ Coná´º Î” Î£
OPEá´º âˆ™        Î´á´º        = Î´á´º
OPEá´º (drop Ïƒ) (Î´á´º , _)  = OPEá´º Ïƒ Î´á´º
OPEá´º (keep Ïƒ) (Î´á´º , tá´º) = OPEá´º Ïƒ Î´á´º , tá´º

OPEá´º-nat : âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î“ Î”)(Î´ : OPE Î Î£) Î½á´º â†’ OPEá´º Ïƒ (Coná´ºâ‚‘ Î´ Î½á´º) â‰¡ Coná´ºâ‚‘ Î´ (OPEá´º Ïƒ Î½á´º)
OPEá´º-nat âˆ™        Î´ Î½á´º        = refl
OPEá´º-nat (drop Ïƒ) Î´ (Î½á´º , tá´º) = OPEá´º-nat Ïƒ Î´ Î½á´º
OPEá´º-nat (keep Ïƒ) Î´ (Î½á´º , tá´º) = (_, Tyá´ºâ‚‘ Î´ tá´º) & OPEá´º-nat Ïƒ Î´ Î½á´º

OPEá´º-idâ‚‘ : âˆ€ {Î“ Î”}(Ïƒá´º : Coná´º Î“ Î”) â†’ OPEá´º idâ‚‘ Ïƒá´º â‰¡ Ïƒá´º
OPEá´º-idâ‚‘ {âˆ™}    tt        = refl
OPEá´º-idâ‚‘ {Î“ , A}(Ïƒá´º , tá´º) = (_, tá´º) & OPEá´º-idâ‚‘ Ïƒá´º

OPEá´º-âˆ˜â‚‘ : âˆ€ {Î“ Î” Î£ Î} Ïƒ Î´ Î½á´º â†’ OPEá´º {Î“}{Î£} (Ïƒ âˆ˜â‚‘ Î´) {Î} Î½á´º â‰¡ OPEá´º {Î”}{Î£} Ïƒ (OPEá´º Î´ Î½á´º)
OPEá´º-âˆ˜â‚‘ Ïƒ        âˆ™        Î½á´º = refl
OPEá´º-âˆ˜â‚‘ Ïƒ        (drop Î´) Î½á´º = OPEá´º-âˆ˜â‚‘ Ïƒ Î´ (projâ‚ Î½á´º)
OPEá´º-âˆ˜â‚‘ (drop Ïƒ) (keep Î´) Î½á´º = OPEá´º-âˆ˜â‚‘ Ïƒ Î´ (projâ‚ Î½á´º)
OPEá´º-âˆ˜â‚‘ (keep Ïƒ) (keep Î´) Î½á´º = (_, projâ‚‚ Î½á´º) & OPEá´º-âˆ˜â‚‘ Ïƒ Î´ (projâ‚ Î½á´º)

-- Tmá´º {Î“}{A} t : PSh ğ’ªPE (Coná´º Î“, Tyá´º A)
--------------------------------------------------------------------------------
mutual
  Tmá´º : âˆ€ {Î“ A} â†’ Tm Î“ A â†’ âˆ€ {Î”} â†’ Coná´º Î“ Î” â†’ Tyá´º A Î”
  Tmá´º (var v)   Ïƒá´º = projâ‚‚ (OPEá´º v Ïƒá´º)
  Tmá´º (lam t)   Ïƒá´º =
    (Î» Î´ aá´º â†’ Tmá´º t (Coná´ºâ‚‘ Î´ Ïƒá´º , aá´º)) ,
    (Î» Î´ Î½ aá´º â†’ (Î» x â†’ Tmá´º t (x , Tyá´ºâ‚‘ Î½ aá´º)) & (Coná´º-âˆ˜â‚‘ Î´ Î½ Ïƒá´º â»Â¹) â»Â¹
              â—¾ Tmá´º-nat t Î½ (Coná´ºâ‚‘ Î´ Ïƒá´º , aá´º))
  Tmá´º (app f a) Ïƒá´º = projâ‚ (Tmá´º f Ïƒá´º) idâ‚‘ (Tmá´º a Ïƒá´º)

  Tmá´º-nat : âˆ€ {Î“ Î” Î£ A}(t : Tm Î“ A)(Ïƒ : OPE Î£ Î”) Î´á´º â†’ Tmá´º t (Coná´ºâ‚‘ Ïƒ Î´á´º) â‰¡ Tyá´ºâ‚‘ Ïƒ (Tmá´º t Î´á´º)
  Tmá´º-nat (var v)   Ïƒ Î´á´º = projâ‚‚ & OPEá´º-nat v Ïƒ Î´á´º
  Tmá´º-nat (lam t)   Ïƒ Î´á´º = â‡’á´ºâ‰¡ Î» Î½ aá´º â†’ (Î» x â†’ Tmá´º t (x , aá´º)) & Coná´º-âˆ˜â‚‘ Ïƒ Î½ Î´á´º â»Â¹
  Tmá´º-nat (app f a) Ïƒ Î´á´º rewrite Tmá´º-nat f Ïƒ Î´á´º | Tmá´º-nat a Ïƒ Î´á´º =
      (Î» x â†’ projâ‚ (Tmá´º f Î´á´º) x (Tyá´ºâ‚‘ Ïƒ (Tmá´º a Î´á´º))) & (idrâ‚‘ Ïƒ â—¾ idlâ‚‘ Ïƒ â»Â¹)
    â—¾ projâ‚‚ (Tmá´º f Î´á´º) idâ‚‘ Ïƒ (Tmá´º a Î´á´º)

Tmâ‚‘á´º :
 âˆ€ {Î“ Î” Î£ A}(Ïƒ : OPE Î” Î“)(t : Tm Î“ A)(Î´á´º : Coná´º Î” Î£)
 â†’ Tmá´º (Tmâ‚‘ Ïƒ t) Î´á´º â‰¡ Tmá´º t (OPEá´º Ïƒ Î´á´º)
Tmâ‚‘á´º Ïƒ (var v)   Î´á´º = projâ‚‚ & OPEá´º-âˆ˜â‚‘ v Ïƒ Î´á´º
Tmâ‚‘á´º Ïƒ (lam t)   Î´á´º = â‡’á´ºâ‰¡ Î» Î½ aá´º â†’
  Tmâ‚‘á´º (keep Ïƒ) t (Coná´ºâ‚‘ Î½ Î´á´º , aá´º) â—¾ (Î» x â†’ Tmá´º t (x , aá´º)) & OPEá´º-nat Ïƒ Î½ Î´á´º
Tmâ‚‘á´º Ïƒ (app f a) Î´á´º rewrite Tmâ‚‘á´º Ïƒ f Î´á´º | Tmâ‚‘á´º Ïƒ a Î´á´º = refl


-- Subá´º {Î“}{Î”} Ïƒ : PSh ğ’ªPE (Coná´º Î“, Coná´º Î”)
--------------------------------------------------------------------------------
Subá´º : âˆ€ {Î“ Î”} â†’ Sub Î“ Î” â†’ âˆ€ {Î£} â†’ Coná´º Î“ Î£ â†’ Coná´º Î” Î£
Subá´º {Î” = âˆ™}    tt      Î´á´º = tt
Subá´º {Î” = Î” , A}(Ïƒ , t) Î´á´º = Subá´º Ïƒ Î´á´º , Tmá´º t Î´á´º

Subá´º-nat : âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î“ Î”)(Î´ : OPE Î Î£) Î½á´º â†’ Subá´º Ïƒ (Coná´ºâ‚‘ Î´ Î½á´º) â‰¡ Coná´ºâ‚‘ Î´ (Subá´º Ïƒ Î½á´º)
Subá´º-nat {Î” = âˆ™}    tt      Î´ Î½á´º = refl
Subá´º-nat {Î” = Î” , A}(Ïƒ , t) Î´ Î½á´º = _,_ & Subá´º-nat Ïƒ Î´ Î½á´º âŠ— Tmá´º-nat t Î´ Î½á´º

Subá´º-â‚›âˆ˜â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : OPE Î“ Î£)(Î½á´º : Coná´º Î“ Î”)
  â†’ Subá´º (Ïƒ â‚›âˆ˜â‚‘ Î´) Î½á´º â‰¡ Subá´º Ïƒ (OPEá´º Î´ Î½á´º)
Subá´º-â‚›âˆ˜â‚‘ {Î = âˆ™}    tt      Î´ Î½á´º = refl
Subá´º-â‚›âˆ˜â‚‘ {Î = Î , A}(Ïƒ , t) Î´ Î½á´º = _,_ & Subá´º-â‚›âˆ˜â‚‘ Ïƒ Î´ Î½á´º âŠ— Tmâ‚‘á´º Î´ t Î½á´º

Tmâ‚›á´º :
 âˆ€ {Î“ Î” Î£ A}(Ïƒ : Sub Î” Î“)(t : Tm Î“ A)(Î´á´º : Coná´º Î” Î£)
 â†’ Tmá´º (Tmâ‚› Ïƒ t) Î´á´º â‰¡ Tmá´º t (Subá´º Ïƒ Î´á´º)
Tmâ‚›á´º Ïƒ (var (drop v)) Î´á´º = Tmâ‚›á´º (projâ‚ Ïƒ) (var v) Î´á´º
Tmâ‚›á´º Ïƒ (var (keep v)) Î´á´º = refl
Tmâ‚›á´º Ïƒ (lam t)   Î´á´º = â‡’á´ºâ‰¡ Î» Î½ aá´º â†’
    Tmâ‚›á´º (keepâ‚› Ïƒ) t (Coná´ºâ‚‘ Î½ Î´á´º , aá´º)
  â—¾ (Î» x â†’ Tmá´º t (x , aá´º)) &
      (Subá´º-â‚›âˆ˜â‚‘ Ïƒ wk (Coná´ºâ‚‘ Î½ Î´á´º , aá´º)
    â—¾ Subá´º Ïƒ & OPEá´º-idâ‚‘ (Coná´ºâ‚‘ Î½ Î´á´º)
    â—¾ Subá´º-nat Ïƒ Î½ Î´á´º)
Tmâ‚›á´º Ïƒ (app f a) Î´á´º rewrite Tmâ‚›á´º Ïƒ f Î´á´º | Tmâ‚›á´º Ïƒ a Î´á´º = refl

Subá´º-idâ‚› : âˆ€ {Î“ Î”}(Ïƒá´º : Coná´º Î“ Î”) â†’ Subá´º idâ‚› Ïƒá´º â‰¡ Ïƒá´º
Subá´º-idâ‚› {âˆ™}     tt         = refl
Subá´º-idâ‚› {Î“ , A} (Ïƒá´º , tá´º) =
  (_, tá´º) & (Subá´º-â‚›âˆ˜â‚‘ idâ‚› wk (Ïƒá´º , tá´º) â—¾ Subá´º-idâ‚› (OPEá´º idâ‚‘ Ïƒá´º) â—¾ OPEá´º-idâ‚‘ Ïƒá´º)

--------------------------------------------------------------------------------

mutual
  qá´º : âˆ€ {A Î“} â†’ Tyá´º A Î“ â†’ Nf Î“ A
  qá´º {Î¹}     tá´º       = tá´º
  qá´º {A â‡’ B} (tá´º , _) = lam (qá´º (tá´º wk (uá´º (var (keep Îµ)))))

  qá´º-nat : âˆ€ {A Î“ Î”}(Ïƒ : OPE Î” Î“)(tá´º : Tyá´º A Î“) â†’ Nfâ‚‘ Ïƒ (qá´º tá´º) â‰¡ qá´º (Tyá´ºâ‚‘ Ïƒ tá´º)
  qá´º-nat {Î¹}     Ïƒ tá´º            = refl
  qá´º-nat {A â‡’ B} Ïƒ (tá´º , tá´º-nat) =
    lam & (qá´º-nat (keep Ïƒ) (tá´º wk (uá´º (var (keep Îµ))))
         â—¾ qá´º & (tá´º-nat wk (keep Ïƒ) (uá´º (var (keep Îµ))) â»Â¹
                â—¾ tá´º & (drop & (idlâ‚‘ Ïƒ â—¾ idrâ‚‘ Ïƒ â»Â¹)) âŠ— (uá´º-nat (keep Ïƒ) (var (keep Îµ))
                                                        â—¾ uá´º & (var & (keep & ÎµÎ· (Îµ âˆ˜â‚‘ Ïƒ))) )))

  uá´º : âˆ€ {A Î“} â†’ Ne Î“ A â†’ Tyá´º A Î“
  uá´º {Î¹}     n = ne n
  uá´º {A â‡’ B} n =
    (Î» Î´ aá´º â†’ uá´º (app (Neâ‚‘ Î´ n) (qá´º aá´º))) ,
    (Î» Ïƒ Î´ aá´º â†’ (Î» x y â†’ uá´º (app x y)) & (Ne-âˆ˜â‚‘ Ïƒ Î´ n â»Â¹) âŠ— qá´º-nat Î´ aá´º â»Â¹
              â—¾ uá´º-nat Î´ (app (Neâ‚‘ Ïƒ n) (qá´º aá´º)) â»Â¹)

  uá´º-nat : âˆ€ {A Î“ Î”}(Ïƒ : OPE Î” Î“)(n : Ne Î“ A) â†’ Tyá´ºâ‚‘ Ïƒ (uá´º n) â‰¡ uá´º (Neâ‚‘ Ïƒ n)
  uá´º-nat {Î¹}     Ïƒ n = refl
  uá´º-nat {A â‡’ B} Ïƒ n = â‡’á´ºâ‰¡ Î» Î´ aá´º â†’ (Î» x â†’ uá´º (app x (qá´º aá´º))) & Ne-âˆ˜â‚‘ Ïƒ Î´ n

uConá´º : âˆ€ {Î“} â†’ Coná´º Î“ Î“
uConá´º {âˆ™}     = tt
uConá´º {Î“ , A} = Coná´ºâ‚‘ wk uConá´º , uá´º (var (keep Îµ))

nf : âˆ€ {Î“ A} â†’ Tm Î“ A â†’ Nf Î“ A
nf t = qá´º (Tmá´º t uConá´º)

--------------------------------------------------------------------------------

_â‰ˆ_ : âˆ€ {A Î“} â†’ Tm Î“ A â†’ Tyá´º A Î“ â†’ Set
_â‰ˆ_ {Î¹}        t tá´º       = t ~ âŒœ qá´º tá´º âŒ
_â‰ˆ_ {A â‡’ B}{Î“} t (tá´º , _) = âˆ€ {Î”}(Ïƒ : OPE Î” Î“){a aá´º} â†’ a â‰ˆ aá´º â†’ app (Tmâ‚‘ Ïƒ t) a â‰ˆ tá´º Ïƒ aá´º

infix 3 _â‰ˆ_ _â‰ˆ*_

data _â‰ˆ*_ {Î“} : âˆ€ {Î”} â†’ Sub Î“ Î” â†’ Coná´º Î” Î“ â†’ Set where
  âˆ™   : _â‰ˆ*_ tt tt
  _,_ : âˆ€ {A Î” Ïƒ Î´}{t : Tm Î“ A}{t' : Tyá´º A Î“} â†’ _â‰ˆ*_ {Î“}{Î”} Ïƒ Î´ â†’ t â‰ˆ t'
        â†’ _â‰ˆ*_ {Î“}{Î” , A} (Ïƒ , t) (Î´ , t')

â‰ˆâ‚‘ : âˆ€ {A Î“ Î”}(Ïƒ : OPE Î” Î“){t}{t' : Tyá´º A Î“} â†’ t â‰ˆ t' â†’ Tmâ‚‘ Ïƒ t â‰ˆ Tyá´ºâ‚‘ Ïƒ t'
â‰ˆâ‚‘ {Î¹}     Ïƒ {t}{tá´º} tâ‰ˆtá´º = coe ((_ ~_) & (âŒœâŒNf-nat Ïƒ tá´º â»Â¹)) (~â‚‘ Ïƒ tâ‰ˆtá´º)
â‰ˆâ‚‘ {A â‡’ B} Ïƒ {t}{tá´º} tâ‰ˆtá´º Î´ rewrite Tm-âˆ˜â‚‘ Ïƒ Î´ t â»Â¹ = tâ‰ˆtá´º (Ïƒ âˆ˜â‚‘ Î´)

â‰ˆ*â‚‘ : âˆ€ {Î“ Î” Î£}(Ïƒ : OPE Î£ Î“){Î´}{Î½á´º : Coná´º Î” Î“} â†’ Î´ â‰ˆ* Î½á´º â†’ (Î´ â‚›âˆ˜â‚‘ Ïƒ) â‰ˆ* Coná´ºâ‚‘ Ïƒ Î½á´º
â‰ˆ*â‚‘ Ïƒ âˆ™              = âˆ™
â‰ˆ*â‚‘ Ïƒ (Î´â‰ˆ*Î½á´º , tâ‰ˆtá´º) = â‰ˆ*â‚‘ Ïƒ Î´â‰ˆ*Î½á´º , â‰ˆâ‚‘ Ïƒ tâ‰ˆtá´º

_~â‰ˆâ—¾_ : âˆ€ {Î“ A}{t t'}{tá´º : Tyá´º A Î“} â†’ t ~ t' â†’ t' â‰ˆ tá´º â†’ t â‰ˆ tá´º
_~â‰ˆâ—¾_ {A = Î¹}     p q = p ~â—¾ q
_~â‰ˆâ—¾_ {A = A â‡’ B} p q = Î» Ïƒ aâ‰ˆaá´º â†’ app (~â‚‘ Ïƒ p) ~refl ~â‰ˆâ—¾ q Ïƒ aâ‰ˆaá´º

âŸ¦TmâŸ§ : âˆ€ {Î“ Î” A}(t : Tm Î“ A){Ïƒ}{Î´á´º : Coná´º Î“ Î”} â†’ Ïƒ â‰ˆ* Î´á´º â†’ Tmâ‚› Ïƒ t â‰ˆ Tmá´º t Î´á´º
âŸ¦TmâŸ§ (var (drop v)) (Ïƒâ‰ˆÎ´á´º , _) = âŸ¦TmâŸ§ (var v) Ïƒâ‰ˆÎ´á´º
âŸ¦TmâŸ§ (var (keep v)) (Ïƒâ‰ˆÎ´á´º , p) = p
âŸ¦TmâŸ§ (lam t) {Ïƒ} {Î´} Ïƒâ‰ˆÎ´á´º Î½ {a} {aá´º} aâ‰ˆaá´º
  = coe ((app (lam (Tmâ‚‘ (keep Î½) (Tmâ‚› (keepâ‚› Ïƒ) t))) a ~_ ) & (Î²â‚‘â‚› Ïƒ Î½ t a â»Â¹))
    (Î² (Tmâ‚‘ (keep Î½) (Tmâ‚› (keepâ‚› Ïƒ) t)) a)
  ~â‰ˆâ—¾ âŸ¦TmâŸ§ t (â‰ˆ*â‚‘ Î½ Ïƒâ‰ˆÎ´á´º , aâ‰ˆaá´º)
âŸ¦TmâŸ§ (app f a) {Ïƒ} {Î´} Ïƒâ‰ˆÎ´á´º
  rewrite Tm-idâ‚‘ (Tmâ‚› Ïƒ f) â»Â¹ = âŸ¦TmâŸ§ f Ïƒâ‰ˆÎ´á´º idâ‚‘ (âŸ¦TmâŸ§ a Ïƒâ‰ˆÎ´á´º)

mutual
  qâ‰ˆ : âˆ€ {Î“ A}{t}{tá´º : Tyá´º A Î“} â†’ t â‰ˆ tá´º â†’ t ~ âŒœ qá´º tá´º âŒ
  qâ‰ˆ {A = Î¹}     tâ‰ˆtá´º = tâ‰ˆtá´º
  qâ‰ˆ {A = A â‡’ B} tâ‰ˆtá´º = Î· _ ~â—¾ lam (qâ‰ˆ (tâ‰ˆtá´º wk (uâ‰ˆ (var (keep Îµ)))))

  uâ‰ˆ : âˆ€ {Î“ A}(n : Ne Î“ A) â†’ âŒœ n âŒNe â‰ˆ uá´º n
  uâ‰ˆ {A = Î¹}     n = ~refl
  uâ‰ˆ {A = A â‡’ B} n Ïƒ {a} {aá´º} aâ‰ˆaá´º
    rewrite âŒœâŒNe-nat Ïƒ n â»Â¹ = app ~refl (qâ‰ˆ aâ‰ˆaá´º) ~â‰ˆâ—¾ uâ‰ˆ (app (Neâ‚‘ Ïƒ n) (qá´º aá´º))

uâ‰ˆ*  : âˆ€ {Î“} â†’ idâ‚› {Î“} â‰ˆ* uConá´º
uâ‰ˆ* {âˆ™}     = âˆ™
uâ‰ˆ* {Î“ , A} = â‰ˆ*â‚‘ wk uâ‰ˆ* , uâ‰ˆ (var (keep Îµ))

complete : âˆ€ {Î“ A}(t : Tm Î“ A) â†’ t ~ âŒœ nf t âŒ
complete t = coe ((_~ âŒœ qá´º (Tmá´º t uConá´º) âŒ) & Tm-idâ‚› t) (qâ‰ˆ (âŸ¦TmâŸ§ t uâ‰ˆ*))

âŸ¦~âŸ§ : âˆ€ {Î“ Î” A}{t t' : Tm Î“ A} â†’ t ~ t' â†’ (Ïƒ : Coná´º Î“ Î”) â†’ Tmá´º t Ïƒ â‰¡ Tmá´º t' Ïƒ
âŸ¦~âŸ§ (Î· t) Ïƒ = â‡’á´ºâ‰¡ Î» {Î£} Î½ aá´º â†’
    (Î» x â†’ projâ‚ (Tmá´º t Ïƒ) x aá´º) & (idrâ‚‘ Î½ â»Â¹)
  â—¾ (Î» x â†’ projâ‚ x idâ‚‘ aá´º) &
        (Tmâ‚‘á´º wk t (Coná´ºâ‚‘ Î½ Ïƒ , aá´º)
      â—¾ Tmá´º t & OPEá´º-idâ‚‘ (Coná´ºâ‚‘ Î½ Ïƒ)
      â—¾ Tmá´º-nat t Î½ Ïƒ) â»Â¹
âŸ¦~âŸ§ (Î² t t')         Ïƒ = (Î» x â†’ Tmá´º t (x , Tmá´º t' Ïƒ)) & (Coná´º-idâ‚‘ Ïƒ â—¾ Subá´º-idâ‚› Ïƒ â»Â¹) â—¾ Tmâ‚›á´º (idâ‚› , t') t Ïƒ â»Â¹
âŸ¦~âŸ§ (lam t~t')       Ïƒ = â‡’á´ºâ‰¡ Î» {Î£} Î½ aá´º â†’ âŸ¦~âŸ§ t~t' (Coná´ºâ‚‘ Î½ Ïƒ , aá´º)
âŸ¦~âŸ§ (app t~t' a~a')  Ïƒ = (Î» f a â†’ projâ‚ f idâ‚‘ a) & âŸ¦~âŸ§ t~t' Ïƒ âŠ— âŸ¦~âŸ§ a~a' Ïƒ
âŸ¦~âŸ§ ~refl            Ïƒ = refl
âŸ¦~âŸ§ (t'~t ~â»Â¹)       Ïƒ = âŸ¦~âŸ§ t'~t Ïƒ â»Â¹
âŸ¦~âŸ§ (t~t' ~â—¾ t'~t'') Ïƒ = âŸ¦~âŸ§ t~t' Ïƒ â—¾ âŸ¦~âŸ§ t'~t'' Ïƒ

sound : âˆ€ {Î“ A}{t t' : Tm Î“ A} â†’ t ~ t' â†’ nf t â‰¡ nf t'
sound t~t' = qá´º & âŸ¦~âŸ§ t~t' uConá´º

mutual
  stab : âˆ€ {Î“ A}(n : Nf Î“ A) â†’ nf âŒœ n âŒ â‰¡ n
  stab (ne n)  = stabNe n
  stab (lam n) = lam & stab n

  stabNe : âˆ€ {Î“ A}(n : Ne Î“ A) â†’ Tmá´º âŒœ n âŒNe uConá´º â‰¡ uá´º n
  stabNe (var (drop v)) =
      projâ‚‚ & OPEá´º-nat v wk uConá´º
    â—¾ Tyá´ºâ‚‘ wk & stabNe (var v)
    â—¾ uá´º-nat wk (var v)
    â—¾ uá´º & (var & (drop & idrâ‚‘ v))
  stabNe (var (keep v)) = uá´º & (var & (keep & (ÎµÎ· v â»Â¹)))
  stabNe (app f a) =
      (Î» x â†’ projâ‚ x idâ‚‘ (Tmá´º âŒœ a âŒ uConá´º)) & stabNe f
    â—¾ (Î» x â†’ uá´º (app (Neâ‚‘ idâ‚‘ f) x)) & stab a
    â—¾ (Î» x â†’ uá´º (app x a)) & Ne-idâ‚‘ f
