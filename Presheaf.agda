{-# OPTIONS --without-K #-}

module Presheaf where

open import Lib hiding (âŠ¤; âŠ¥)
import Lib as L
open import UIP
open import Syntax
open import Embedding
open import Substitution
open import Nf

-- Tyá´º A : (F : PSh ğ’ªPE) Ã— (qá´º : PSh ğ’ªPE (F, (Nf _ A))) Ã— (uá´º : PSh ğ’ªPE ((Ne _ A), F))
--------------------------------------------------------------------------------

data +á´º (A B C : Set) : Set where
  ne+  : A â†’ +á´º A B C
  injâ‚ : B â†’ +á´º A B C
  injâ‚‚ : C â†’ +á´º A B C

mutual
  Tyá´º : Ty â†’ Con â†’ Set
  Tyá´º âŠ¤       Î“ = Nf Î“ âŠ¤
  Tyá´º âŠ¥       Î“ = Ne Î“ âŠ¥
  Tyá´º (A * B) Î“ = Tyá´º A Î“ Ã— Tyá´º B Î“
  Tyá´º (A + B) Î“ = +á´º (Ne Î“ (A + B)) (Tyá´º A Î“) (Tyá´º B Î“)
  Tyá´º (A â‡’ B) Î“ =
    Î£ (âˆ€ {Î”} â†’ OPE Î” Î“ â†’ Tyá´º A Î” â†’ Tyá´º B Î”) Î» fá´º â†’
    âˆ€ {Î” Î£}(Ïƒ : OPE Î” Î“)(Î´ : OPE Î£ Î”) aá´º â†’ fá´º (Ïƒ âˆ˜â‚‘ Î´) (Tyá´ºâ‚‘ {A} Î´ aá´º) â‰¡ Tyá´ºâ‚‘ {B} Î´ (fá´º Ïƒ aá´º)

  Tyá´ºâ‚‘ : âˆ€ {A Î“ Î”} â†’ OPE Î” Î“ â†’ Tyá´º A Î“ â†’ Tyá´º A Î”
  Tyá´ºâ‚‘ {âŠ¤}     Ïƒ tá´º = Nfâ‚‘ Ïƒ tá´º
  Tyá´ºâ‚‘ {âŠ¥}     Ïƒ tá´º = Neâ‚‘ Ïƒ tá´º
  Tyá´ºâ‚‘ {A â‡’ B} Ïƒ (tá´º , tá´º-nat) =
    (Î» Î´ â†’ tá´º (Ïƒ âˆ˜â‚‘ Î´)) ,
    (Î» Î´ Î½ aá´º â†’ (Î» x â†’ tá´º x (Tyá´ºâ‚‘ {A} Î½ aá´º)) & (assâ‚‘ Ïƒ Î´ Î½ â»Â¹) â—¾ tá´º-nat (Ïƒ âˆ˜â‚‘ Î´) Î½ aá´º)
  Tyá´ºâ‚‘ {A * B} Ïƒ (tá´º , uá´º) = Tyá´ºâ‚‘ {A} Ïƒ tá´º , Tyá´ºâ‚‘ {B} Ïƒ uá´º
  Tyá´ºâ‚‘ {A + B} Ïƒ (ne+  n)  = ne+ (Neâ‚‘ Ïƒ n)
  Tyá´ºâ‚‘ {A + B} Ïƒ (injâ‚ tá´º) = injâ‚ (Tyá´ºâ‚‘ {A} Ïƒ tá´º)
  Tyá´ºâ‚‘ {A + B} Ïƒ (injâ‚‚ tá´º) = injâ‚‚ (Tyá´ºâ‚‘ {B} Ïƒ tá´º)

â‡’á´ºâ‰¡ :
  âˆ€ {A B Î“}{f f' : Tyá´º (A â‡’ B) Î“}
  â†’ (âˆ€ {Î”}(Ïƒ : OPE Î” Î“) a â†’ projâ‚ f Ïƒ a â‰¡ projâ‚ f' Ïƒ a)
  â†’ f â‰¡ f'
â‡’á´ºâ‰¡ {f = f}{f'} eq = ,Î£=
  (funexti Î» _ â†’ funext Î» Ïƒ â†’ funext Î» aá´º â†’ eq Ïƒ aá´º )
  (funexti Î» _ â†’ funexti Î» _ â†’ funext Î» _ â†’ funext Î» _ â†’ funext Î» _ â†’ UIP _ _)

Tyá´º-idâ‚‘ : âˆ€ {A Î“}(tá´º : Tyá´º A Î“) â†’ Tyá´ºâ‚‘ {A} idâ‚‘ tá´º â‰¡ tá´º
Tyá´º-idâ‚‘ {âŠ¤}     tá´º        = Nf-idâ‚‘ tá´º
Tyá´º-idâ‚‘ {âŠ¥}     tá´º        = Ne-idâ‚‘ tá´º
Tyá´º-idâ‚‘ {A * B} (tá´º , uá´º) = _,_ & Tyá´º-idâ‚‘ {A} tá´º âŠ— Tyá´º-idâ‚‘ {B} uá´º
Tyá´º-idâ‚‘ {A + B} (ne+ n)   = ne+ & Ne-idâ‚‘ n
Tyá´º-idâ‚‘ {A + B} (injâ‚ tá´º) = injâ‚ & Tyá´º-idâ‚‘ {A} tá´º
Tyá´º-idâ‚‘ {A + B} (injâ‚‚ tá´º) = injâ‚‚ & Tyá´º-idâ‚‘ {B} tá´º
Tyá´º-idâ‚‘ {A â‡’ B} (tá´º , _)  = â‡’á´ºâ‰¡ {A}{B} Î» Ïƒ aá´º â†’ (Î» x â†’ tá´º x aá´º) & idlâ‚‘ Ïƒ

Tyá´º-âˆ˜â‚‘ :
  âˆ€ {A Î“ Î” Î£}(tá´º : Tyá´º A Î£)(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)
  â†’ Tyá´ºâ‚‘ {A} (Ïƒ âˆ˜â‚‘ Î´) tá´º â‰¡ Tyá´ºâ‚‘ {A} Î´ (Tyá´ºâ‚‘ {A} Ïƒ tá´º)
Tyá´º-âˆ˜â‚‘ {âŠ¤}     tá´º        Ïƒ Î´ = Nf-âˆ˜â‚‘ Ïƒ Î´ tá´º
Tyá´º-âˆ˜â‚‘ {A â‡’ B} (tá´º , _)  Ïƒ Î´ = â‡’á´ºâ‰¡ {A}{B} Î» Î½ aá´º â†’ (Î» x â†’ tá´º x aá´º) & assâ‚‘ Ïƒ Î´ Î½
Tyá´º-âˆ˜â‚‘ {âŠ¥}     tá´º        Ïƒ Î´ = Ne-âˆ˜â‚‘ Ïƒ Î´ tá´º
Tyá´º-âˆ˜â‚‘ {A * B} (tá´º , uá´º) Ïƒ Î´ = _,_ & Tyá´º-âˆ˜â‚‘ {A} tá´º Ïƒ Î´ âŠ— Tyá´º-âˆ˜â‚‘ {B} uá´º Ïƒ Î´
Tyá´º-âˆ˜â‚‘ {A + B} (ne+ n)   Ïƒ Î´ = ne+ & Ne-âˆ˜â‚‘ Ïƒ Î´ n
Tyá´º-âˆ˜â‚‘ {A + B} (injâ‚ tá´º) Ïƒ Î´ = injâ‚ & Tyá´º-âˆ˜â‚‘ {A} tá´º Ïƒ Î´
Tyá´º-âˆ˜â‚‘ {A + B} (injâ‚‚ tá´º) Ïƒ Î´ = injâ‚‚ & Tyá´º-âˆ˜â‚‘ {B} tá´º Ïƒ Î´

mutual
  qá´º : âˆ€ {A Î“} â†’ Tyá´º A Î“ â†’ Nf Î“ A
  qá´º {âŠ¤}     tá´º        = tt
  qá´º {âŠ¥}     tá´º        = neâŠ¥ tá´º
  qá´º {A * B} (aá´º , bá´º) = qá´º aá´º , qá´º bá´º
  qá´º {A â‡’ B} (tá´º , _)  = lam (qá´º (tá´º wk (uá´º {A} (var vz))))
  qá´º {A + B} (ne+ n)   = ne+ n
  qá´º {A + B} (injâ‚ a)  = injâ‚ (qá´º a)
  qá´º {A + B} (injâ‚‚ b)  = injâ‚‚ (qá´º b)

  qá´º-nat : âˆ€ {A Î“ Î”}(Ïƒ : OPE Î” Î“)(tá´º : Tyá´º A Î“) â†’ Nfâ‚‘ Ïƒ (qá´º {A} tá´º) â‰¡ qá´º (Tyá´ºâ‚‘ {A} Ïƒ tá´º)
  qá´º-nat {âŠ¤}     Ïƒ tá´º = refl
  qá´º-nat {âŠ¥}     Ïƒ tá´º = refl
  qá´º-nat {A â‡’ B} Ïƒ (tá´º , tá´º-nat) =
    lam & (qá´º-nat (keep Ïƒ) (tá´º wk (uá´º {A}(var vz)))
         â—¾ qá´º & (tá´º-nat wk (keep Ïƒ) (uá´º {A} (var vz)) â»Â¹
                â—¾ tá´º & (drop & (idlâ‚‘ Ïƒ â—¾ idrâ‚‘ Ïƒ â»Â¹)) âŠ— uá´º-nat (keep Ïƒ) (var vz)))
  qá´º-nat {A * B} Ïƒ (tá´º , uá´º) = _,_ & qá´º-nat {A} Ïƒ tá´º âŠ— qá´º-nat {B} Ïƒ uá´º
  qá´º-nat {A + B} Ïƒ (ne+ n)   = refl
  qá´º-nat {A + B} Ïƒ (injâ‚ tá´º) = injâ‚ & qá´º-nat {A} Ïƒ tá´º
  qá´º-nat {A + B} Ïƒ (injâ‚‚ tá´º) = injâ‚‚ & qá´º-nat {B} Ïƒ tá´º

  uá´º : âˆ€ {A Î“} â†’ Ne Î“ A â†’ Tyá´º A Î“
  uá´º {âŠ¤}     n = tt
  uá´º {âŠ¥}     n = n
  uá´º {A * B} n = uá´º (Ï€â‚ n) , uá´º (Ï€â‚‚ n)
  uá´º {A â‡’ B} n =
    (Î» Î´ aá´º â†’ uá´º (app (Neâ‚‘ Î´ n) (qá´º aá´º))) ,
    (Î» Ïƒ Î´ aá´º â†’ (Î» x y â†’ uá´º (app x y)) & (Ne-âˆ˜â‚‘ Ïƒ Î´ n â»Â¹) âŠ— qá´º-nat Î´ aá´º â»Â¹
              â—¾ uá´º-nat Î´ (app (Neâ‚‘ Ïƒ n) (qá´º aá´º)) â»Â¹)
  uá´º {A + B} n = ne+ n

  uá´º-nat : âˆ€ {A Î“ Î”}(Ïƒ : OPE Î” Î“)(n : Ne Î“ A) â†’ Tyá´ºâ‚‘ {A} Ïƒ (uá´º {A} n) â‰¡ uá´º (Neâ‚‘ Ïƒ n)
  uá´º-nat {âŠ¤}     Ïƒ n = refl
  uá´º-nat {âŠ¥}     Ïƒ n = refl
  uá´º-nat {A â‡’ B} Ïƒ n = â‡’á´ºâ‰¡ {A}{B} Î» Î´ aá´º â†’ (Î» x â†’ uá´º {B} (Ne.app x (qá´º {A} aá´º))) & Ne-âˆ˜â‚‘ Ïƒ Î´ n
  uá´º-nat {A * B} Ïƒ n = _,_ & uá´º-nat {A} Ïƒ (Ï€â‚ n) âŠ— uá´º-nat {B} Ïƒ (Ï€â‚‚ n)
  uá´º-nat {A + B} Ïƒ n = refl


-- Coná´º Î“ : PSh ğ’ªPE
--------------------------------------------------------------------------------
data Coná´º : Con â†’ Con â†’ Set where
  âˆ™   : âˆ€ {Î“} â†’ Coná´º âˆ™ Î“
  _,_ : âˆ€ {A Î“ Î”} (Ïƒ : Coná´º Î“ Î”)(t : Tyá´º A Î”) â†’ Coná´º (Î“ , A) Î”
infixr 5 _,_

Coná´ºâ‚‘ : âˆ€ {Î“ Î”} â†’ OPE Î” Î“ â†’ âˆ€ {Î£} â†’ Coná´º Î£ Î“ â†’ Coná´º Î£ Î”
Coná´ºâ‚‘ Ïƒ âˆ™              = âˆ™
Coná´ºâ‚‘ Ïƒ (_,_ {A} Î´ tá´º) =  Coná´ºâ‚‘ Ïƒ Î´ , Tyá´ºâ‚‘ {A} Ïƒ tá´º

Coná´º-idâ‚‘ : âˆ€ {Î“ Î”}(Î“á´º : Coná´º Î“ Î”) â†’ Coná´ºâ‚‘ idâ‚‘ Î“á´º â‰¡ Î“á´º
Coná´º-idâ‚‘ âˆ™              = refl
Coná´º-idâ‚‘ (_,_ {A} Î“á´º t) = _,_ & Coná´º-idâ‚‘ Î“á´º âŠ— Tyá´º-idâ‚‘ {A} t

Coná´º-âˆ˜â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î” Î£)(Î´ : OPE Î“ Î”)(Î½ : Coná´º Î Î£)
  â†’ Coná´ºâ‚‘ (Ïƒ âˆ˜â‚‘ Î´) Î½ â‰¡ Coná´ºâ‚‘ Î´ (Coná´ºâ‚‘ Ïƒ Î½)
Coná´º-âˆ˜â‚‘ Ïƒ Î´ âˆ™             = refl
Coná´º-âˆ˜â‚‘ Ïƒ Î´ (_,_ {A} Î½ t) = _,_ & Coná´º-âˆ˜â‚‘ Ïƒ Î´ Î½ âŠ— Tyá´º-âˆ˜â‚‘ {A} t Ïƒ Î´

--------------------------------------------------------------------------------

âˆˆá´º : âˆ€ {Î“ A} â†’ A âˆˆ Î“ â†’ âˆ€ {Î”} â†’ Coná´º Î“ Î” â†’ Tyá´º A Î”
âˆˆá´º vz     (Ïƒ , t) = t
âˆˆá´º (vs v) (Ïƒ , t) = âˆˆá´º v Ïƒ

âˆˆá´º-nat : âˆ€ {A Î“ Î” Î£}(v : A âˆˆ Î“)(Ïƒ : OPE Î£ Î”) Î“á´º â†’ âˆˆá´º v (Coná´ºâ‚‘ Ïƒ Î“á´º) â‰¡ Tyá´ºâ‚‘ {A} Ïƒ (âˆˆá´º v Î“á´º)
âˆˆá´º-nat vz     Ïƒ (Î“á´º , _) = refl
âˆˆá´º-nat (vs v) Ïƒ (Î“á´º , _) = âˆˆá´º-nat v Ïƒ Î“á´º

-- Tmá´º {Î“}{A} t : PSh ğ’ªPE(Coná´º Î“, Tyá´º A)
--------------------------------------------------------------------------------

mutual
  Tmá´º : âˆ€ {A Î“} â†’ Tm Î“ A â†’ âˆ€ {Î”} â†’ Coná´º Î“ Î” â†’ Tyá´º A Î”
  Tmá´º (var v)   Î“á´º = âˆˆá´º v Î“á´º
  Tmá´º {A â‡’ B}(lam t)  Î“á´º =
    (Î» Î´ aá´º â†’ Tmá´º t (Coná´ºâ‚‘ Î´ Î“á´º , aá´º)) ,
    (Î» Î´ Î½ aá´º â†’ (Î» x â†’ Tmá´º {B} t (x , Tyá´ºâ‚‘ {A} Î½ aá´º)) & (Coná´º-âˆ˜â‚‘ Î´ Î½ Î“á´º â»Â¹) â»Â¹
              â—¾ Tmá´º-nat {B} t Î½ (Coná´ºâ‚‘ Î´ Î“á´º , aá´º))
  Tmá´º (app f a) Î“á´º = projâ‚ (Tmá´º f Î“á´º) idâ‚‘ (Tmá´º a Î“á´º)
  Tmá´º tt Î“á´º = tt
  Tmá´º (Ï€â‚ t) Î“á´º = projâ‚ (Tmá´º t Î“á´º)
  Tmá´º (Ï€â‚‚ t) Î“á´º = projâ‚‚ (Tmá´º t Î“á´º)
  Tmá´º (t , u) Î“á´º = Tmá´º t Î“á´º , Tmá´º u Î“á´º
  Tmá´º (injâ‚ t) Î“á´º = injâ‚ (Tmá´º t Î“á´º)
  Tmá´º (injâ‚‚ t) Î“á´º = injâ‚‚ (Tmá´º t Î“á´º)
  Tmá´º {C} (case {A} {B} l r t) Î“á´º with Tmá´º t Î“á´º
  ... | ne+ n = uá´º {C}
    (case (qá´º (Tmá´º l (Coná´ºâ‚‘ wk Î“á´º , uá´º {A}(var vz))))
          (qá´º (Tmá´º r (Coná´ºâ‚‘ wk Î“á´º , uá´º {B}(var vz))))
          n)
  ... | injâ‚ tá´º = Tmá´º l (Î“á´º , tá´º)
  ... | injâ‚‚ tá´º = Tmá´º r (Î“á´º , tá´º)
  Tmá´º {A} (âŠ¥-rec t) Î“á´º = uá´º {A} (âŠ¥-rec (Tmá´º t Î“á´º))

  Tmá´º-nat : âˆ€ {A Î“ Î” Î£}(t : Tm Î“ A)(Ïƒ : OPE Î£ Î”) Î“á´º â†’ Tmá´º t (Coná´ºâ‚‘ Ïƒ Î“á´º) â‰¡ Tyá´ºâ‚‘ {A} Ïƒ (Tmá´º t Î“á´º)
  Tmá´º-nat {A} (var v)     Ïƒ Î“á´º = âˆˆá´º-nat {A} v Ïƒ Î“á´º
  Tmá´º-nat {A â‡’ B} (lam t) Ïƒ Î“á´º = â‡’á´ºâ‰¡ {A}{B} Î» Î½ aá´º â†’ (Î» x â†’ Tmá´º t (x , aá´º)) & Coná´º-âˆ˜â‚‘ Ïƒ Î½ Î“á´º â»Â¹
  Tmá´º-nat {B} (app {A} f a) Ïƒ Î“á´º rewrite Tmá´º-nat f Ïƒ Î“á´º | Tmá´º-nat a Ïƒ Î“á´º =
      (Î» x â†’ projâ‚ (Tmá´º f Î“á´º) x (Tyá´ºâ‚‘ {A} Ïƒ (Tmá´º a Î“á´º))) & (idrâ‚‘ Ïƒ â—¾ idlâ‚‘ Ïƒ â»Â¹)
    â—¾ projâ‚‚ (Tmá´º f Î“á´º) idâ‚‘ Ïƒ (Tmá´º a Î“á´º)
  Tmá´º-nat tt            Ïƒ Î“á´º = refl
  Tmá´º-nat (Ï€â‚ t)        Ïƒ Î“á´º = projâ‚ & Tmá´º-nat t Ïƒ Î“á´º
  Tmá´º-nat (Ï€â‚‚ t)        Ïƒ Î“á´º = projâ‚‚ & Tmá´º-nat t Ïƒ Î“á´º
  Tmá´º-nat (t , u)       Ïƒ Î“á´º = _,_ & Tmá´º-nat t Ïƒ Î“á´º âŠ— Tmá´º-nat u Ïƒ Î“á´º
  Tmá´º-nat (injâ‚ t)      Ïƒ Î“á´º = injâ‚ & Tmá´º-nat t Ïƒ Î“á´º
  Tmá´º-nat (injâ‚‚ t)      Ïƒ Î“á´º = injâ‚‚ & Tmá´º-nat t Ïƒ Î“á´º
  Tmá´º-nat (âŠ¥-rec {A} t) Ïƒ Î“á´º =
    (uá´º {A} âˆ˜ âŠ¥-rec) & Tmá´º-nat t Ïƒ Î“á´º â—¾ uá´º-nat {A} Ïƒ (âŠ¥-rec (Tmá´º t Î“á´º)) â»Â¹
  Tmá´º-nat {C} (case {A} {B} l r t) Ïƒ Î“á´º rewrite Tmá´º-nat {A + B} t Ïƒ Î“á´º with Tmá´º t Î“á´º
  ... | ne+  n  =
      uá´º {C} &
        (case &
             (qá´º & (Tmá´º l &
                 (_,_ &
                       (Coná´º-âˆ˜â‚‘ Ïƒ wk Î“á´º â»Â¹
                     â—¾ (Î» x â†’ Coná´ºâ‚‘ (drop x) Î“á´º) & (idrâ‚‘ Ïƒ â—¾ idlâ‚‘ Ïƒ â»Â¹)
                     â—¾ Coná´º-âˆ˜â‚‘ wk (keep Ïƒ) Î“á´º)
                   âŠ— (uá´º-nat {A} (keep Ïƒ) (var vz) â»Â¹))
                 â—¾ Tmá´º-nat l (keep Ïƒ) (Coná´ºâ‚‘ wk Î“á´º , uá´º {A} (var vz)))
             â—¾ qá´º-nat {C} (keep Ïƒ) (Tmá´º l (Coná´ºâ‚‘ wk Î“á´º , uá´º {A} (var vz))) â»Â¹)
          âŠ—
             (qá´º & (Tmá´º r &
                 (_,_ &
                       (Coná´º-âˆ˜â‚‘ Ïƒ wk Î“á´º â»Â¹
                     â—¾ (Î» x â†’ Coná´ºâ‚‘ (drop x) Î“á´º) & (idrâ‚‘ Ïƒ â—¾ idlâ‚‘ Ïƒ â»Â¹)
                     â—¾ Coná´º-âˆ˜â‚‘ wk (keep Ïƒ) Î“á´º)
                   âŠ— (uá´º-nat {B} (keep Ïƒ) (var vz) â»Â¹))
                 â—¾ Tmá´º-nat r (keep Ïƒ) (Coná´ºâ‚‘ wk Î“á´º , uá´º {B} (var vz)))
             â—¾ qá´º-nat {C} (keep Ïƒ) (Tmá´º r (Coná´ºâ‚‘ wk Î“á´º , uá´º {B} (var vz))) â»Â¹)
          âŠ— refl)
    â—¾ uá´º-nat {C} Ïƒ
        (case (qá´º (Tmá´º l (Coná´ºâ‚‘ wk Î“á´º , uá´º {A} (var vz))))
              (qá´º (Tmá´º r (Coná´ºâ‚‘ wk Î“á´º , uá´º {B} (var vz))))
              n) â»Â¹
  ... | injâ‚ tá´º = Tmá´º-nat l Ïƒ (Î“á´º , tá´º)
  ... | injâ‚‚ tá´º = Tmá´º-nat r Ïƒ (Î“á´º , tá´º)


-- OPEá´º {Î“}{Î”} Ïƒ : PSh(Coná´º Î“, Coná´º Î”)
--------------------------------------------------------------------------------
OPEá´º : âˆ€ {Î“ Î”} â†’ OPE Î“ Î” â†’ âˆ€ {Î£} â†’ Coná´º Î“ Î£ â†’ Coná´º Î” Î£
OPEá´º âˆ™        Î“á´º        = Î“á´º
OPEá´º (drop Ïƒ) (Î“á´º , _)  = OPEá´º Ïƒ Î“á´º
OPEá´º (keep Ïƒ) (Î“á´º , tá´º) = OPEá´º Ïƒ Î“á´º , tá´º

OPEá´º-nat : âˆ€ {Î“ Î” Î£ Î}(Ïƒ : OPE Î“ Î”)(Î´ : OPE Î Î£) Î“á´º â†’ OPEá´º Ïƒ (Coná´ºâ‚‘ Î´ Î“á´º) â‰¡ Coná´ºâ‚‘ Î´ (OPEá´º Ïƒ Î“á´º)
OPEá´º-nat âˆ™        Î´ Î“á´º        = refl
OPEá´º-nat (drop Ïƒ) Î´ (Î“á´º , tá´º) = OPEá´º-nat Ïƒ Î´ Î“á´º
OPEá´º-nat (keep {A} Ïƒ) Î´ (Î“á´º , tá´º) = (_, Tyá´ºâ‚‘ {A} Î´ tá´º) & OPEá´º-nat Ïƒ Î´ Î“á´º

OPEá´º-idâ‚‘ : âˆ€ {Î“ Î”}(Î“á´º : Coná´º Î“ Î”) â†’ OPEá´º idâ‚‘ Î“á´º â‰¡ Î“á´º
OPEá´º-idâ‚‘ âˆ™         = refl
OPEá´º-idâ‚‘ (Î“á´º , tá´º) = (_, tá´º) & OPEá´º-idâ‚‘ Î“á´º

âˆˆâ‚‘á´º :
 âˆ€ {Î“ Î” Î£ A}(Ïƒ : OPE Î” Î“)(v : A âˆˆ Î“)(Î“á´º : Coná´º Î” Î£)
 â†’ âˆˆá´º (âˆˆâ‚‘ Ïƒ v) Î“á´º â‰¡ âˆˆá´º v (OPEá´º Ïƒ Î“á´º)
âˆˆâ‚‘á´º âˆ™        v      Î“á´º        = refl
âˆˆâ‚‘á´º (drop Ïƒ) v      (Î“á´º , _)  = âˆˆâ‚‘á´º Ïƒ v Î“á´º
âˆˆâ‚‘á´º (keep Ïƒ) vz     (Î“á´º , tá´º) = refl
âˆˆâ‚‘á´º (keep Ïƒ) (vs v) (Î“á´º , tá´º) = âˆˆâ‚‘á´º Ïƒ v Î“á´º

Tmâ‚‘á´º :
 âˆ€ {A Î“ Î” Î£}(Ïƒ : OPE Î” Î“)(t : Tm Î“ A)(Î“á´º : Coná´º Î” Î£)
 â†’ Tmá´º (Tmâ‚‘ Ïƒ t) Î“á´º â‰¡ Tmá´º t (OPEá´º Ïƒ Î“á´º)
Tmâ‚‘á´º Ïƒ (var v)   Î“á´º = âˆˆâ‚‘á´º Ïƒ v Î“á´º
Tmâ‚‘á´º Ïƒ (lam {A} {B} t) Î“á´º = â‡’á´ºâ‰¡ {A}{B} Î» Î½ aá´º â†’
  Tmâ‚‘á´º (keep Ïƒ) t (Coná´ºâ‚‘ Î½ Î“á´º , aá´º) â—¾ (Î» x â†’ Tmá´º t (x , aá´º)) & OPEá´º-nat Ïƒ Î½ Î“á´º
Tmâ‚‘á´º Ïƒ (app f a) Î“á´º rewrite Tmâ‚‘á´º Ïƒ f Î“á´º | Tmâ‚‘á´º Ïƒ a Î“á´º = refl
Tmâ‚‘á´º Ïƒ tt Î“á´º = refl
Tmâ‚‘á´º Ïƒ (Ï€â‚ t) Î“á´º = projâ‚ & Tmâ‚‘á´º Ïƒ t Î“á´º
Tmâ‚‘á´º Ïƒ (Ï€â‚‚ t) Î“á´º = projâ‚‚ & Tmâ‚‘á´º Ïƒ t Î“á´º
Tmâ‚‘á´º Ïƒ (t , u) Î“á´º = _,_ & Tmâ‚‘á´º Ïƒ t Î“á´º âŠ— Tmâ‚‘á´º Ïƒ u Î“á´º
Tmâ‚‘á´º Ïƒ (injâ‚ t) Î“á´º = injâ‚ & Tmâ‚‘á´º Ïƒ t Î“á´º
Tmâ‚‘á´º Ïƒ (injâ‚‚ t) Î“á´º = injâ‚‚ & Tmâ‚‘á´º Ïƒ t Î“á´º
Tmâ‚‘á´º {C} Ïƒ (case {A}{B} l r t) Î“á´º rewrite Tmâ‚‘á´º Ïƒ t Î“á´º with Tmá´º t (OPEá´º Ïƒ Î“á´º)
... | ne+ n  =
  uá´º {C} & (case &
           (qá´º & (Tmâ‚‘á´º (keep Ïƒ) l ((Coná´ºâ‚‘ wk Î“á´º) , uá´º {A} _)
               â—¾ (Î» x â†’ Tmá´º l (x , uá´º {A} _)) & OPEá´º-nat Ïƒ wk Î“á´º))
         âŠ— qá´º & (Tmâ‚‘á´º (keep Ïƒ) r ((Coná´ºâ‚‘ wk Î“á´º) , uá´º {B} _)
               â—¾ (Î» x â†’ Tmá´º r (x , uá´º {B} _)) & OPEá´º-nat Ïƒ wk Î“á´º)
         âŠ— refl)
... | injâ‚ tá´º = Tmâ‚‘á´º (keep Ïƒ) l (Î“á´º , tá´º)
... | injâ‚‚ tá´º = Tmâ‚‘á´º (keep Ïƒ) r (Î“á´º , tá´º)
Tmâ‚‘á´º Ïƒ (âŠ¥-rec {A} t) Î“á´º = (uá´º {A} âˆ˜ âŠ¥-rec) & Tmâ‚‘á´º Ïƒ t Î“á´º

-- Subá´º {Î“}{Î”} Ïƒ : PSh(Coná´º Î“, Coná´º Î”)
--------------------------------------------------------------------------------

Subá´º : âˆ€ {Î“ Î”} â†’ Sub Î“ Î” â†’ âˆ€ {Î£} â†’ Coná´º Î“ Î£ â†’ Coná´º Î” Î£
Subá´º âˆ™       Î“á´º = âˆ™
Subá´º (Ïƒ , t) Î“á´º = Subá´º Ïƒ Î“á´º , Tmá´º t Î“á´º

Subá´º-nat : âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î“ Î”)(Î´ : OPE Î Î£) Î“á´º â†’ Subá´º Ïƒ (Coná´ºâ‚‘ Î´ Î“á´º) â‰¡ Coná´ºâ‚‘ Î´ (Subá´º Ïƒ Î“á´º)
Subá´º-nat âˆ™       Î´ Î“á´º = refl
Subá´º-nat (Ïƒ , t) Î´ Î“á´º = _,_ & Subá´º-nat Ïƒ Î´ Î“á´º âŠ— Tmá´º-nat t Î´ Î“á´º

Subá´º-â‚›âˆ˜â‚‘ :
  âˆ€ {Î“ Î” Î£ Î}(Ïƒ : Sub Î£ Î)(Î´ : OPE Î“ Î£)(Î“á´º : Coná´º Î“ Î”)
  â†’ Subá´º (Ïƒ â‚›âˆ˜â‚‘ Î´) Î“á´º â‰¡ Subá´º Ïƒ (OPEá´º Î´ Î“á´º)
Subá´º-â‚›âˆ˜â‚‘ âˆ™       Î´ Î“á´º = refl
Subá´º-â‚›âˆ˜â‚‘ (Ïƒ , t) Î´ Î“á´º = _,_ & Subá´º-â‚›âˆ˜â‚‘ Ïƒ Î´ Î“á´º âŠ— Tmâ‚‘á´º Î´ t Î“á´º

âˆˆâ‚›á´º :
 âˆ€ {Î“ Î” Î£ A}(Ïƒ : Sub Î” Î“)(v : A âˆˆ Î“)(Î“á´º : Coná´º Î” Î£)
 â†’ Tmá´º (âˆˆâ‚› Ïƒ v) Î“á´º â‰¡ âˆˆá´º v (Subá´º Ïƒ Î“á´º)
âˆˆâ‚›á´º (Ïƒ , t) vz     Î“á´º = refl
âˆˆâ‚›á´º (Ïƒ , _) (vs v) Î“á´º = âˆˆâ‚›á´º Ïƒ v Î“á´º

Tmâ‚›á´º :
 âˆ€ {A Î“ Î” Î£}(Ïƒ : Sub Î” Î“)(t : Tm Î“ A)(Î“á´º : Coná´º Î” Î£)
 â†’ Tmá´º (Tmâ‚› Ïƒ t) Î“á´º â‰¡ Tmá´º t (Subá´º Ïƒ Î“á´º)
Tmâ‚›á´º Ïƒ (var v)   Î“á´º = âˆˆâ‚›á´º Ïƒ v Î“á´º
Tmâ‚›á´º Ïƒ (lam {A} {B} t) Î“á´º = â‡’á´ºâ‰¡ {A}{B} Î» Î½ aá´º â†’
    Tmâ‚›á´º (keepâ‚› Ïƒ) t (Coná´ºâ‚‘ Î½ Î“á´º , aá´º)
  â—¾ (Î» x â†’ Tmá´º t (x , aá´º)) &
      (Subá´º-â‚›âˆ˜â‚‘ Ïƒ wk (Coná´ºâ‚‘ Î½ Î“á´º , aá´º)
    â—¾ Subá´º Ïƒ & OPEá´º-idâ‚‘ (Coná´ºâ‚‘ Î½ Î“á´º)
    â—¾ Subá´º-nat Ïƒ Î½ Î“á´º)
Tmâ‚›á´º Ïƒ (app f a) Î“á´º rewrite Tmâ‚›á´º Ïƒ f Î“á´º | Tmâ‚›á´º Ïƒ a Î“á´º = refl
Tmâ‚›á´º Ïƒ tt Î“á´º = refl
Tmâ‚›á´º Ïƒ (Ï€â‚ t) Î“á´º = projâ‚ & Tmâ‚›á´º Ïƒ t Î“á´º
Tmâ‚›á´º Ïƒ (Ï€â‚‚ t) Î“á´º = projâ‚‚ & Tmâ‚›á´º Ïƒ t Î“á´º
Tmâ‚›á´º Ïƒ (t , u) Î“á´º = _,_ & Tmâ‚›á´º Ïƒ t Î“á´º âŠ— Tmâ‚›á´º Ïƒ u Î“á´º
Tmâ‚›á´º Ïƒ (injâ‚ t) Î“á´º = injâ‚ & Tmâ‚›á´º Ïƒ t Î“á´º
Tmâ‚›á´º Ïƒ (injâ‚‚ t) Î“á´º = injâ‚‚ & Tmâ‚›á´º Ïƒ t Î“á´º
Tmâ‚›á´º {C} Ïƒ (case {A}{B} l r t) Î“á´º rewrite Tmâ‚›á´º Ïƒ t Î“á´º with Tmá´º t (Subá´º Ïƒ Î“á´º)
... | ne+ n   =
  uá´º {C} &
    (case &
           (qá´º & (Tmâ‚›á´º (keepâ‚› Ïƒ) l _
          â—¾ (Î» x â†’ Tmá´º l (x , uá´º {A} _)) & (Subá´º-â‚›âˆ˜â‚‘ Ïƒ wk _ â—¾ Subá´º Ïƒ & OPEá´º-idâ‚‘ _ â—¾ Subá´º-nat Ïƒ wk Î“á´º)))
        âŠ—  (qá´º & (Tmâ‚›á´º (keepâ‚› Ïƒ) r _
          â—¾ (Î» x â†’ Tmá´º r (x , uá´º {B} _)) & (Subá´º-â‚›âˆ˜â‚‘ Ïƒ wk _ â—¾ Subá´º Ïƒ & OPEá´º-idâ‚‘ _ â—¾ Subá´º-nat Ïƒ wk Î“á´º)))
        âŠ— refl)
... | injâ‚ tá´º =
    Tmâ‚›á´º (keepâ‚› Ïƒ) l (Î“á´º , tá´º)
  â—¾ (Î» x â†’ Tmá´º l (x , tá´º)) & (Subá´º-â‚›âˆ˜â‚‘ Ïƒ wk (Î“á´º , tá´º) â—¾ Subá´º Ïƒ & OPEá´º-idâ‚‘ Î“á´º)
... | injâ‚‚ tá´º =
    Tmâ‚›á´º (keepâ‚› Ïƒ) r (Î“á´º , tá´º)
  â—¾ (Î» x â†’ Tmá´º r (x , tá´º)) & (Subá´º-â‚›âˆ˜â‚‘ Ïƒ wk (Î“á´º , tá´º) â—¾ Subá´º Ïƒ & OPEá´º-idâ‚‘ Î“á´º)
Tmâ‚›á´º Ïƒ (âŠ¥-rec {A} t) Î“á´º = (uá´º {A} âˆ˜ âŠ¥-rec) & Tmâ‚›á´º Ïƒ t Î“á´º

Subá´º-idâ‚› : âˆ€ {Î“ Î”}(Î“á´º : Coná´º Î“ Î”) â†’ Subá´º idâ‚› Î“á´º â‰¡ Î“á´º
Subá´º-idâ‚› âˆ™         = refl
Subá´º-idâ‚› (Î“á´º , tá´º) =
  (_, tá´º) & (Subá´º-â‚›âˆ˜â‚‘ idâ‚› wk (Î“á´º , tá´º) â—¾ Subá´º-idâ‚› (OPEá´º idâ‚‘ Î“á´º) â—¾ OPEá´º-idâ‚‘ Î“á´º)
